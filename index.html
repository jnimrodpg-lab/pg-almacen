<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TIENDAS PG ‚Ä¢ Localizador</title>

<style>
  :root{
    --bg:#f6f6f6; --card:#ffffff; --text:#111827; --muted:#6b7280;
    --border:#e5e7eb; --primary:#2563eb; --danger:#dc2626;
    --warn:#f59e0b; --ok:#16a34a; --shadow:0 10px 25px rgba(0,0,0,.08);
    --radius:14px;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text); padding:20px; }

  body.dark{
    --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
    --border:#1f2937; --shadow:0 10px 25px rgba(0,0,0,.35);
  }

  .topbar{
    max-width:1200px; margin:0 auto 16px auto;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  .brand{ display:flex; align-items:center; gap:12px; }
  .logoMark{
    width:44px;height:44px;border-radius:14px;
    background: linear-gradient(135deg, #111827, #374151);
    box-shadow: var(--shadow); position:relative; overflow:hidden;
  }
  .logoMark::before,.logoMark::after{
    content:""; position:absolute; top:10px; width:10px; height:24px;
    border-radius:6px; background: rgba(255,255,255,.85); opacity:.9;
  }
  .logoMark::before{ left:12px; } .logoMark::after{ right:12px; }
  .logoBase{
    position:absolute; left:10px; right:10px; bottom:8px;
    height:4px; border-radius:999px; background: rgba(255,255,255,.75);
  }
  .brandText{ display:flex; flex-direction:column; line-height:1.05; }
  .brandText .title{ font-size:18px; font-weight:900; letter-spacing:.5px; margin:0; }
  .brandText .subtitle{ font-size:12px; color:var(--muted); margin-top:4px; }
  .brandText .tag{
    display:inline-flex; align-items:center; gap:6px;
    margin-top:6px; font-size:11px;
    border:1px solid var(--border); background:var(--card);
    padding:6px 10px; border-radius:999px; width:max-content;
  }

  .topActions{ display:flex; gap:10px; align-items:center; }
  .toggle{
    border:1px solid var(--border);
    background:var(--card);
    color:var(--text);
    border-radius:999px;
    padding:10px 12px;
    cursor:pointer;
    box-shadow:0 6px 18px rgba(0,0,0,.05);
    font-size:13px;
  }

  .status{
    display:flex; align-items:center; gap:8px;
    padding:10px 12px; border:1px solid var(--border);
    border-radius:999px; background:var(--card);
    box-shadow:0 6px 18px rgba(0,0,0,.05);
    white-space:nowrap; font-size:13px; color:var(--muted);
  }
  .dot{ width:10px;height:10px;border-radius:999px;background:var(--warn); }
  .dot.ok{ background:var(--ok); } .dot.bad{ background:var(--danger); }

  .layout{
    max-width:1200px; margin:0 auto; display:grid;
    grid-template-columns: 1.1fr .9fr; gap:16px; align-items:start;
  }
  @media (max-width: 980px){
    .layout{ grid-template-columns:1fr; }
    .sticky{ position:static !important; }
  }

  .card{
    background:var(--card); border:1px solid var(--border);
    border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
  }
  .card-header{
    padding:14px 14px 10px 14px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .card-header h2{ font-size:14px; margin:0; }
  .meta{ font-size:12px; color:var(--muted); }

  .controls{ padding:14px; display:grid; gap:10px; }
  .search input{
    width:100%; padding:12px; font-size:15px;
    border:1px solid var(--border); border-radius:12px; outline:none;
    background:var(--card); color:var(--text);
  }
  .search input:focus{
    border-color: rgba(37, 99, 235, .6);
    box-shadow: 0 0 0 4px rgba(37,99,235,.12);
  }

  .btnrow{ display:flex; gap:10px; flex-wrap:wrap; }
  .btn{
    flex:1; min-width:140px; border:none; border-radius:12px;
    padding:12px; font-size:14px; cursor:pointer; color:#fff;
    display:flex; align-items:center; justify-content:center; gap:8px;
  }
  .btn.primary{ background:var(--primary); }
  .btn.danger{ background:var(--danger); }
  .btn.dark{ background:#111827; }
  body.dark .btn.dark{ background:#334155; }

  .chiprow{ display:flex; gap:8px; flex-wrap:wrap; }
  .chip{
    border:1px solid var(--border);
    background:var(--card); color:var(--text);
    border-radius:999px;
    padding:8px 10px;
    font-size:12px;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:8px;
    user-select:none;
  }
  .chip .badge{
    font-size:11px;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#f9fafb;
    color:var(--muted);
  }
  body.dark .chip .badge{ background:#0b1220; }
  .chip.active{
    border-color: rgba(37,99,235,.35);
    box-shadow: 0 0 0 4px rgba(37,99,235,.10);
  }
  .chip.active .badge{
    border-color: rgba(37,99,235,.35);
    background: rgba(37,99,235,.08);
    color: #1f3b8f;
  }
  .hint{ font-size:12px; color:var(--muted); line-height:1.4; }

  .result-card{
    margin-top:6px; padding:12px; border:1px dashed var(--border);
    border-radius:12px; background:rgba(0,0,0,.02); display:none;
  }
  body.dark .result-card{ background:rgba(255,255,255,.03); }
  .result-title{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .bigloc{ margin-top:8px; font-size:22px; font-weight:800; letter-spacing:.5px; }
  .sub{ margin-top:6px; font-size:12px; color:var(--muted); }

  .kv{ margin-top:10px; display:grid; gap:8px; }
  .kv-row{
    display:flex; justify-content:space-between; gap:10px;
    padding:10px 12px; border:1px solid var(--border);
    border-radius:12px; background:var(--card); font-size:12px;
  }
  .kv-row b{ color:var(--text); }
  .kv-row span{ color:var(--muted); text-align:right; }

  .picker{ margin-top:10px; display:flex; gap:10px; align-items:center; }
  .picker button{
    border:1px solid var(--border); background:var(--card); color:var(--text);
    border-radius:12px; padding:10px 12px; cursor:pointer;
    flex:1; min-width:120px; font-weight:700;
  }
  .picker button:disabled{ opacity:.45; cursor:not-allowed; }
  .picker .counter{
    padding:10px 12px; border:1px solid var(--border);
    background:var(--card); border-radius:12px; color:var(--muted);
    font-size:12px; white-space:nowrap;
  }

  .table-wrap{ border-top:1px solid var(--border); }
  .table-scroll{ max-height: 520px; overflow:auto; }
  table{ width:100%; border-collapse:collapse; font-size:13px; }
  thead th{
    position:sticky; top:0; background:#111827; color:#fff;
    text-align:left; padding:10px; z-index:2;
  }
  tbody td{ padding:10px; border-bottom:1px solid var(--border); vertical-align:top; }
  tbody tr:nth-child(even){ background:rgba(0,0,0,.02); }
  body.dark tbody tr:nth-child(even){ background:rgba(255,255,255,.03); }
  tbody tr.active{
    background:#fff7ed !important;
    outline:2px solid rgba(245, 158, 11, .35);
  }
  body.dark tbody tr.active{ background:rgba(245, 158, 11, .12) !important; }

  .sticky{ position: sticky; top: 20px; }
  #isoWrap{ padding:14px; }
  #isoMap{
    width:100%;
    height:420px;
    border:1px solid var(--border);
    border-radius:12px;
    background:var(--card);
    display:block;
  }

  .iso-zone{ transition:.18s; }
  .iso-zone.z1{ fill:rgba(20,184,166,.10); stroke:rgba(20,184,166,.55); }
  .iso-zone.z2{ fill:rgba(45,212,191,.10); stroke:rgba(45,212,191,.55); }
  .iso-zone.z3{ fill:rgba(94,234,212,.10); stroke:rgba(94,234,212,.55); }
  .iso-zone.a1{ fill:rgba(147,197,253,.10); stroke:rgba(147,197,253,.55); }
  body.dark .iso-zone.z1{ fill:rgba(20,184,166,.06); stroke:rgba(20,184,166,.45); }
  body.dark .iso-zone.z2{ fill:rgba(45,212,191,.06); stroke:rgba(45,212,191,.45); }
  body.dark .iso-zone.z3{ fill:rgba(94,234,212,.06); stroke:rgba(94,234,212,.45); }
  body.dark .iso-zone.a1{ fill:rgba(147,197,253,.06); stroke:rgba(147,197,253,.45); }

  .iso-zone.mainHL{ fill:rgba(251,191,36,.25) !important; stroke:#f97316 !important; stroke-width:3; }
  .iso-zone.storeHL{ fill:rgba(34,197,94,.18) !important; stroke:#16a34a !important; stroke-width:3; }

  .rack{ cursor:pointer; transition:.18s; }
  .rack.dim{ opacity:.25; }
  .rack .post{ stroke:#64748b; stroke-width:2.3; stroke-linecap:round; }
  .rack .shelfTop{ fill:#cbd5e1; stroke:#64748b; stroke-width:1; }
  .rack .shelfFront{ fill:#94a3b8; }
  .rack .shelfRight{ fill:#a3b3c8; }

  body.dark .rack .post{ stroke:#94a3b8; }
  body.dark .rack .shelfTop{ fill:#243045; stroke:#94a3b8; }
  body.dark .rack .shelfFront{ fill:#1f2a3d; }
  body.dark .rack .shelfRight{ fill:#22314b; }

  .rack.mainHL .post{ stroke:#f97316; }
  .rack.mainHL .shelfTop{ fill:#fef3c7; stroke:#f97316; }
  .rack.mainHL .shelfFront{ fill:#fbbf24; }
  .rack.mainHL .shelfRight{ fill:#f59e0b; }

  .rack.storeHL .post{ stroke:#16a34a; }
  .rack.storeHL .shelfTop{ fill:#dcfce7; stroke:#16a34a; }
  .rack.storeHL .shelfFront{ fill:#86efac; }
  .rack.storeHL .shelfRight{ fill:#22c55e; }

  .rack.hoverHL .post{ stroke:#2563eb; }
  .rack.hoverHL .shelfTop{ fill:rgba(37,99,235,.15); stroke:#2563eb; }

  #reader{ display:none; padding:0 14px 14px 14px; }
  .pill{
    padding:6px 10px; border-radius:999px;
    font-size:12px; border:1px solid var(--border);
    background:var(--card); color:var(--muted); white-space:nowrap;
  }
  .map-info{
    padding:12px 14px; border-top:1px solid var(--border);
    display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
  }
  .map-info .msg{ font-size:13px; color:var(--muted); line-height:1.4; }

  /* ===== Vista Estante Isom√©trica ===== */
  .shelfIsoWrap{
    width:100%;
    border:1px solid var(--border);
    border-radius:12px;
    background:var(--card);
    overflow:hidden;
  }
  .shelfIsoTopbar{
    padding:10px 12px;
    border-bottom:1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    font-size:12px;
    color:var(--muted);
  }
  .shelfIsoSvg{
    width:100%;
    height:260px;
    display:block;
  }
</style>
</head>

<body>

<div class="topbar">
  <div class="brand">
    <div class="logoMark"><div class="logoBase"></div></div>
    <div class="brandText">
      <div class="title">TIENDAS PG</div>
      <div class="subtitle">Localizador de inventario</div>
      <div class="tag">üè¨ TIENDA</div>
    </div>
  </div>

  <div class="topActions">
    <button class="toggle" id="btnDark">üåô Modo oscuro</button>
    <div class="status">
      <span class="dot" id="statusDot"></span>
      <span id="statusText">Cargando hoja‚Ä¶</span>
    </div>
  </div>
</div>

<div class="layout">

  <!-- IZQUIERDA -->
  <div class="card">
    <div class="card-header">
      <div>
        <h2>B√∫squeda</h2>
        <div class="meta" id="metaCount">0 productos</div>
      </div>
      <div class="meta" id="metaResults">0 resultados</div>
    </div>

    <div class="controls">
      <div class="search">
        <input id="buscar" type="text" placeholder="Ej: bvd emperador blanco s  |  z1-e1-n6-s2  |  a1-e2-n6-s3" autocomplete="off" />
      </div>

      <div class="chiprow">
        <div class="chip active" id="chipReducido" role="button" tabindex="0">
          Reducido (por nombre) <span class="badge" id="badgeReducido">0</span>
        </div>
        <div class="chip" id="chipDetallado" role="button" tabindex="0">
          Detallado (todo) <span class="badge" id="badgeDetallado">0</span>
        </div>
      </div>

      <div class="btnrow">
        <button class="btn primary" id="btnScan" type="button">üì∑ Escanear</button>
        <button class="btn danger" id="btnCerrar" type="button" style="display:none;">‚ùå Cerrar</button>
        <button class="btn dark" id="btnClear" type="button">üßπ Limpiar</button>
      </div>

      <div class="hint">
        <b>Reducido:</b> 1 fila por nombre. <b>Detallado:</b> todas las coincidencias.
      </div>

      <div class="result-card" id="resultCard">
        <div class="result-title">
          <strong>Resultado activo</strong>
          <span class="pill" id="pillZona">‚Äî</span>
        </div>

        <div class="bigloc" id="bigLoc">‚Äî</div>
        <div class="sub" id="subLoc">‚Äî</div>

        <div class="kv">
          <div class="kv-row"><b>üìç Ubicaci√≥n</b><span id="kvUbicacion">‚Äî</span></div>
          <div class="kv-row"><b>üß± Estante</b><span id="kvEstante">‚Äî</span></div>
          <div class="kv-row"><b>üìö Nivel</b><span id="kvNivel">‚Äî</span></div>
          <div class="kv-row"><b>üéØ Slot</b><span id="kvSlot">‚Äî</span></div>
          <div class="kv-row"><b>üì¶ Almac√©n</b><span id="kvAlmacen">‚Äî</span></div>
        </div>

        <div class="picker">
          <button id="btnPrev" type="button">‚óÄ Anterior</button>
          <div class="counter" id="pickerCounter">0 / 0</div>
          <button id="btnNext" type="button">Siguiente ‚ñ∂</button>
        </div>
      </div>
    </div>

    <div id="reader"></div>

    <div class="table-wrap">
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th style="width:140px;">Barras</th>
              <th>Nombre</th>
              <th style="width:160px;">Variante</th>
              <th style="width:170px;">Ubicaci√≥n</th>
              <th style="width:170px;">Almac√©n</th>
            </tr>
          </thead>
          <tbody id="tabla"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- DERECHA -->
  <div class="card sticky">
    <div class="card-header">
      <div>
        <h2>Plano general</h2>
        <div class="meta">Isom√©trico ‚Ä¢ Hover filtra por estante</div>
      </div>
      <div class="meta" id="mapBadge">‚Äî</div>
    </div>

    <div id="isoWrap">
      <svg id="isoMap" viewBox="-600 -120 1200 760" preserveAspectRatio="xMidYMid meet"></svg>
    </div>

    <!-- VISTA ESTANTE ISO -->
    <div style="padding:14px; border-top:1px solid var(--border);">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
        <div style="font-weight:800;">Vista estante (isom√©trico)</div>
        <div class="pill" id="shelfLabel">‚Äî</div>
      </div>

      <div id="shelfPreview" style="min-height:280px;">
        <div style="color:var(--muted); font-size:13px;">
          Selecciona un producto para ver el estante y la celda resaltada.
        </div>
      </div>
    </div>

    <div class="map-info">
      <div class="msg" id="info">Escribe para buscar o pasa el mouse por los racks.</div>
      <div class="pill" id="resultCountPill">0</div>
    </div>
  </div>

</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* =========================
   CONFIG
========================= */
const sheetID   = "1IU4wMdVImmEbl93kgcCCQAGPiTc28uQdNNaq0bgTF2o";
const sheetName = "Mujer";

/* ===== LAYOUT FIJO POR ZONA ===== */
const ZONE_LAYOUT = {
  Z1: { rows: 2, cols: 4, order: ["Z1-E1","Z1-E2","Z1-E3","Z1-E4","Z1-E5","Z1-E6","Z1-E7","Z1-E8"] },
  Z2: { rows: 2, cols: 5, order: ["Z2-E1","Z2-E2","Z2-E3","Z2-E4","Z2-E5","Z2-E6","Z2-E7","Z2-E8","Z2-E9","Z2-E10"] },
  Z3: { rows: 3, cols: 3, order: ["Z3-E1","Z3-E2","Z3-E3","Z3-E4","Z3-E5","Z3-E6","Z3-E7","Z3-E8","Z3-E9"] },
  A1: { rows: 3, cols: 4, order: ["A1-E1","A1-E2","A1-E3","A1-E4","A1-E5","A1-E6","A1-E7","A1-E8","A1-E9","A1-E10","A1-E11","A1-E12"] },
};

/* Vista estante */
const DEFAULT_SLOT = 2;    // si no viene slot, usamos el medio (ahora s√≠ soporta slot)
const SLOTS_PER_LEVEL = 3; // ‚úÖ lo que pediste: estante con 3 espacios por nivel

/* =========================
   UI refs
========================= */
const tabla = document.getElementById("tabla");
const buscador = document.getElementById("buscar");
const info = document.getElementById("info");
const metaCount = document.getElementById("metaCount");
const metaResults = document.getElementById("metaResults");
const mapBadge = document.getElementById("mapBadge");
const resultCountPill = document.getElementById("resultCountPill");

const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");

const resultCard = document.getElementById("resultCard");
const pillZona = document.getElementById("pillZona");
const bigLoc = document.getElementById("bigLoc");
const subLoc = document.getElementById("subLoc");

const kvUbicacion = document.getElementById("kvUbicacion");
const kvEstante = document.getElementById("kvEstante");
const kvNivel = document.getElementById("kvNivel");
const kvSlot = document.getElementById("kvSlot");
const kvAlmacen = document.getElementById("kvAlmacen");

const btnClear = document.getElementById("btnClear");
const btnPrev = document.getElementById("btnPrev");
const btnNext = document.getElementById("btnNext");
const pickerCounter = document.getElementById("pickerCounter");

const chipReducido = document.getElementById("chipReducido");
const chipDetallado = document.getElementById("chipDetallado");
const badgeReducido = document.getElementById("badgeReducido");
const badgeDetallado = document.getElementById("badgeDetallado");

const shelfPreview = document.getElementById("shelfPreview");
const shelfLabel = document.getElementById("shelfLabel");

const btnDark = document.getElementById("btnDark");
const isoMap = document.getElementById("isoMap");

/* =========================
   STATE
========================= */
let productos = [];
let resultadosDetallado = [];
let resultadosReducido = [];
let resultadosActuales = [];
let indiceActual = 0;
let modo = "reducido";
let isLoaded = false;

let racksIndex = { Z1:[], Z2:[], Z3:[], A1:[] };
let rackNodes = new Map();
let zoneNodes = new Map();
let lastHoverQuery = null;

/* =========================
   Feedback
========================= */
let audioCtx = null;
function beep(freq = 880, ms = 90, vol = 0.06){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine"; o.frequency.value = freq; g.gain.value = vol;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); setTimeout(() => o.stop(), ms);
  }catch(e){}
}
function vibrar(pattern = [60, 40, 60]){
  try{ if (navigator.vibrate) navigator.vibrate(pattern); }catch(e){}
}
function feedbackOK(){
  beep(880, 80, 0.06);
  setTimeout(() => beep(1320, 70, 0.05), 90);
  vibrar([50, 35, 50]);
}

/* =========================
   Helpers
========================= */
function setStatus(type, text){
  statusDot.className = "dot" + (type === "ok" ? " ok" : type === "bad" ? " bad" : "");
  statusText.textContent = text;
}
function escapeHtml(str){
  return String(str || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function norm(s){
  return String(s || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9\s-]/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}
function tokens(s){
  const stop = new Set(["talla","color","de","para","con","sin","un","una","y","el","la","los","las"]);
  return norm(s).split(" ").filter(w => w && !stop.has(w));
}
function matchAll(textoNorm, qTokens){
  for (const t of qTokens) if (!textoNorm.includes(t)) return false;
  return true;
}

/* =========================
   Parse loc: Z1/Z2/Z3/A1
   expected:
     z1-e1-n6
     z1-e1-n6-s2   ‚úÖ ahora soporta slot
========================= */
function parseLoc(raw){
  const s = String(raw || "").trim().toUpperCase();
  // slot opcional: -S\d+
  const m = s.match(/^(Z[123]|A1)-(E\d+)-(N\d+)(?:-(S\d+))?$/);
  if (!m) return { zonaId:"", estanteId:"", nivelId:"", levelNum:0, slotNum:0, pretty:s };

  const zonaId = m[1];
  const estanteId = `${zonaId}-${m[2]}`;
  const levelNum = parseInt(m[3].replace("N",""), 10) || 0;
  const slotNum = m[4] ? (parseInt(m[4].replace("S",""), 10) || 0) : 0;

  const nivelId = `${estanteId}-${m[3]}`;
  return { zonaId, estanteId, nivelId, levelNum, slotNum, pretty:s };
}

/* =========================
   ISOMETRIC helpers
========================= */
const ISO_ANGLE = 30 * (Math.PI / 180);
const COS_30 = Math.cos(ISO_ANGLE);
const SIN_30 = Math.sin(ISO_ANGLE);
const toScreen = (x,y,z)=>({ x:(x-y)*COS_30, y:(x+y)*SIN_30 - z });

function svgEl(tag, attrs = {}, children = []){
  const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
  for (const [k,v] of Object.entries(attrs)){
    if (v === null || v === undefined) continue;
    el.setAttribute(k, String(v));
  }
  for (const c of children) el.appendChild(c);
  return el;
}
function isoFace(coords, attrs){
  const d = `M ${coords[0].x} ${coords[0].y} L ${coords[1].x} ${coords[1].y} L ${coords[2].x} ${coords[2].y} L ${coords[3].x} ${coords[3].y} Z`;
  return svgEl("path", { d, ...attrs });
}
function isoLine(from, to, attrs){
  return svgEl("line", { x1:from.x, y1:from.y, x2:to.x, y2:to.y, ...attrs });
}

/* =========================
   Vista estante (ISOM√âTRICA)
   - muestra todos los niveles
   - 3 slots por nivel
   - pinta SOLO la celda del producto (por slot)
========================= */
function renderShelfIso(estanteId, levelNum, slotNum){
  const isAlmacen = estanteId.startsWith("A1-");
  const levels = isAlmacen ? 8 : 6;
  const slots = SLOTS_PER_LEVEL;

  // clamp
  const safeLevel = Math.max(1, Math.min(levels, levelNum || 1));
  const safeSlot  = Math.max(1, Math.min(slots, slotNum || DEFAULT_SLOT));

  const rackW = 190;                 // m√°s corto porque 3 slots
  const rackD = 90;
  const rackH = 220;
  const shelfSpacing = rackH / levels;

  const viewBox = "-240 -300 480 440";
  const svg = svgEl("svg", { class:"shelfIsoSvg", viewBox, preserveAspectRatio:"xMidYMid meet" });

  // floor tile
  svg.appendChild(isoFace(
    [toScreen(-20,-20,0), toScreen(rackW+20,-20,0), toScreen(rackW+20,rackD+20,0), toScreen(-20,rackD+20,0)],
    {
      fill: document.body.classList.contains("dark") ? "#0b1220" : "#f8fafc",
      stroke: document.body.classList.contains("dark") ? "#1f2937" : "#cbd5e1",
      "stroke-width":"1"
    }
  ));

  // posts
  const postStyle = { stroke: document.body.classList.contains("dark") ? "#94a3b8" : "#64748b", "stroke-width":"3", "stroke-linecap":"round" };
  // back
  svg.appendChild(isoLine(toScreen(0,0,0), toScreen(0,0,rackH), postStyle));
  svg.appendChild(isoLine(toScreen(rackW,0,0), toScreen(rackW,0,rackH), postStyle));

  const thickness = 3;
  const slotW = rackW / slots;
  const fillHL = "#f97316";
  const strokeHL = "#ea580c";

  for (let i=0;i<levels;i++){
    const z = i*shelfSpacing + 10;
    const lvl = i + 1;
    const isTargetLevel = lvl === safeLevel;

    // shelf surfaces
    const top = [toScreen(0,0,z), toScreen(rackW,0,z), toScreen(rackW,rackD,z), toScreen(0,rackD,z)];
    const front = [toScreen(0,rackD,z), toScreen(rackW,rackD,z), toScreen(rackW,rackD,z-thickness), toScreen(0,rackD,z-thickness)];
    const right = [toScreen(rackW,0,z), toScreen(rackW,rackD,z), toScreen(rackW,rackD,z-thickness), toScreen(rackW,0,z-thickness)];

    svg.appendChild(isoFace(top, {
      fill: document.body.classList.contains("dark") ? "#243045" : "#e2e8f0",
      stroke: document.body.classList.contains("dark") ? "#94a3b8" : "#94a3b8",
      "stroke-width":"0.7",
      opacity: isTargetLevel ? "1" : "0.85"
    }));
    svg.appendChild(isoFace(front, { fill: document.body.classList.contains("dark") ? "#1f2a3d" : "#cbd5e1", opacity:"0.85" }));
    svg.appendChild(isoFace(right, { fill: document.body.classList.contains("dark") ? "#22314b" : "#b6c2d3", opacity:"0.85" }));

    // label N#
    const labelPos = toScreen(-16, rackD/2, z + shelfSpacing/2);
    const txt = svgEl("text", {
      x: labelPos.x, y: labelPos.y,
      "text-anchor":"middle",
      "font-size": isTargetLevel ? "12" : "10",
      "font-weight": isTargetLevel ? "900" : "700",
      fill: isTargetLevel ? "#f97316" : (document.body.classList.contains("dark") ? "#94a3b8" : "#94a3b8"),
      "font-family":"monospace"
    });
    txt.textContent = `N${lvl}`;
    svg.appendChild(txt);

    // slots grid
    for (let s=1;s<=slots;s++){
      const x0 = (s-1)*slotW + 3;
      const w = slotW - 6;

      const cellTop = [
        toScreen(x0, 8, z + 1),
        toScreen(x0+w, 8, z + 1),
        toScreen(x0+w, rackD-8, z + 1),
        toScreen(x0, rackD-8, z + 1),
      ];

      const isTargetCell = (lvl === safeLevel) && (s === safeSlot);

      svg.appendChild(isoFace(cellTop, {
        fill: isTargetCell ? fillHL : "transparent",
        stroke: isTargetCell ? strokeHL : (document.body.classList.contains("dark") ? "rgba(148,163,184,.30)" : "rgba(148,163,184,.35)"),
        "stroke-width": isTargetCell ? "1.6" : "0.8",
        opacity: isTargetCell ? "0.95" : "1"
      }));
    }
  }

  // front posts last
  svg.appendChild(isoLine(toScreen(0,rackD,0), toScreen(0,rackD,rackH), postStyle));
  svg.appendChild(isoLine(toScreen(rackW,rackD,0), toScreen(rackW,rackD,rackH), postStyle));

  // top label
  const lp = toScreen(rackW/2, rackD/2, rackH + 16);
  svg.appendChild(svgEl("rect", {
    x: lp.x - 52, y: lp.y - 12, width: 104, height: 20, rx: 6,
    fill: document.body.classList.contains("dark") ? "#0b1220" : "#ffffff",
    stroke: "#f97316", "stroke-width":"2"
  }));
  const tl = svgEl("text", {
    x: lp.x, y: lp.y + 4,
    "text-anchor":"middle", "font-size":"12", "font-weight":"900", "font-family":"monospace",
    fill: document.body.classList.contains("dark") ? "#e5e7eb" : "#1e293b"
  });
  tl.textContent = estanteId;
  svg.appendChild(tl);

  const wrap = document.createElement("div");
  wrap.className = "shelfIsoWrap";
  wrap.innerHTML = `
    <div class="shelfIsoTopbar">
      <span>Slots por nivel: <b>${slots}</b></span>
      <span>Celda pintada: <b>N${safeLevel}</b> / <b>S${safeSlot}</b></span>
    </div>
  `;
  wrap.appendChild(svg);

  return wrap;
}

function mostrarVistaEstante(estanteId, levelNum, slotNum){
  if (!estanteId){
    shelfLabel.textContent = "‚Äî";
    shelfPreview.innerHTML = `<div style="color:var(--muted); font-size:13px;">
      Selecciona un producto para ver el estante y la celda resaltada.
    </div>`;
    return;
  }
  shelfLabel.textContent = estanteId;
  shelfPreview.innerHTML = "";
  shelfPreview.appendChild(renderShelfIso(estanteId, levelNum || 1, slotNum || DEFAULT_SLOT));
}

/* =========================
   Reducido por nombre
========================= */
function agruparPorNombre(listaDetallada){
  const map = new Map();
  for (const p of listaDetallada){
    const key = (p.nombreNormKey || p.nombreNorm || p.nombre || "").trim();
    if (!key) continue;

    if (!map.has(key)){
      map.set(key, { key, count: 1, representante: p, grupo: [p] });
    } else {
      const g = map.get(key);
      g.count++;
      g.grupo.push(p);
      if ((p._score||0) > (g.representante._score||0)) g.representante = p;
    }
  }

  const reducido = [];
  for (const g of map.values()){
    reducido.push({
      ...g.representante,
      variante: `${g.count} variantes`,
      _grupo: g.grupo,
      _count: g.count,
      _representante: g.representante
    });
  }

  reducido.sort((a,b) => (b._score||0) - (a._score||0));
  return reducido;
}

/* =========================
   Table render
========================= */
function renderTabla(lista, activeIndex = -1){
  let html = "";
  for (let i=0;i<lista.length;i++){
    const p = lista[i];
    const active = i === activeIndex ? " class='active'" : "";
    html += `
      <tr${active} data-i="${i}">
        <td>${escapeHtml(p.barras || "")}</td>
        <td>${escapeHtml(p.nombre || "")}</td>
        <td>${escapeHtml(p.variante || "")}</td>
        <td>${escapeHtml(p.ubic || "")}</td>
        <td>${escapeHtml(p.almacen || "")}</td>
      </tr>`;
  }
  tabla.innerHTML = html;
  enlazarTabla();
}
function enlazarTabla(){
  const rows = tabla.querySelectorAll("tr");
  rows.forEach(tr => {
    tr.addEventListener("mouseenter", () => {
      const i = Number(tr.getAttribute("data-i"));
      const fila = resultadosActuales.length ? resultadosActuales[i] : productos[i];
      const item = (fila && fila._representante) ? fila._representante : fila;
      if (!item) return;

      applyHoverHL(item.mainLoc?.estanteId || "", item.storeLoc?.estanteId || "");
      mapBadge.textContent = item.mainLoc?.zonaId || "‚Äî";
    });

    tr.addEventListener("click", () => {
      const i = Number(tr.getAttribute("data-i"));
      if (!Number.isNaN(i)){
        indiceActual = i;
        aplicarResultadoActivo(true);
      }
    });
  });

  tabla.addEventListener("mouseleave", () => {
    clearHoverHL();
    if (resultadosActuales.length){
      aplicarResultadoActivo(false);
    } else {
      mapBadge.textContent = "‚Äî";
      info.textContent = "Escribe para buscar o pasa el mouse por los racks.";
    }
  }, { once:false });
}

/* =========================
   Picker
========================= */
function setPickerState(){
  const total = resultadosActuales.length;
  pickerCounter.textContent = `${total ? (indiceActual + 1) : 0} / ${total}`;
  btnPrev.disabled = total <= 1;
  btnNext.disabled = total <= 1;
}

/* =========================
   Chips
========================= */
function setModo(nuevo){
  modo = nuevo;
  chipReducido.classList.toggle("active", modo === "reducido");
  chipDetallado.classList.toggle("active", modo === "detallado");

  if (buscador.value.trim()){
    resultadosActuales = (modo === "reducido") ? resultadosReducido : resultadosDetallado;
    indiceActual = 0;
    aplicarResultadoActivo(false);
  } else {
    resultadosActuales = [];
    indiceActual = 0;
    renderTabla(productos);
    resultCard.style.display = "none";
    clearAllHL();
    mostrarVistaEstante("", 0, 0);
    metaResults.textContent = "0 resultados";
    resultCountPill.textContent = "0";
  }
}
chipReducido.addEventListener("click", () => setModo("reducido"));
chipDetallado.addEventListener("click", () => setModo("detallado"));

/* =========================
   Clear
========================= */
function limpiarBusqueda(){
  buscador.value = "";
  resultadosDetallado = [];
  resultadosReducido = [];
  resultadosActuales = [];
  indiceActual = 0;

  metaResults.textContent = "0 resultados";
  resultCountPill.textContent = "0";
  badgeDetallado.textContent = "0";
  badgeReducido.textContent = "0";

  resultCard.style.display = "none";
  clearAllHL();

  info.textContent = "Escribe para buscar o pasa el mouse por los racks.";
  mapBadge.textContent = "‚Äî";
  mostrarVistaEstante("", 0, 0);

  renderTabla(productos);
  buscador.focus();
}
btnClear.addEventListener("click", limpiarBusqueda);

/* =========================
   Search
========================= */
function recalcularResultados(triggerFeedback=false){
  if (!isLoaded) return;

  const qRaw = buscador.value.trim();
  if (!qRaw){
    resultadosDetallado = [];
    resultadosReducido = [];
    resultadosActuales = [];
    indiceActual = 0;
    metaResults.textContent = "0 resultados";
    resultCountPill.textContent = "0";
    badgeDetallado.textContent = "0";
    badgeReducido.textContent = "0";
    resultCard.style.display = "none";
    clearAllHL();
    mostrarVistaEstante("", 0, 0);
    renderTabla(productos);
    return;
  }

  const q = tokens(qRaw);

  resultadosDetallado = productos
    .filter(p => matchAll(p.fulltextNorm, q))
    .map(p => {
      let score = 0;
      for (const t of q) score += p.nvNorm.includes(t) ? 10 : 2;
      return { ...p, _score: score };
    })
    .sort((a,b) => (b._score||0) - (a._score||0));

  resultadosReducido = agruparPorNombre(resultadosDetallado);
  resultadosActuales = (modo === "reducido") ? resultadosReducido : resultadosDetallado;
  indiceActual = 0;
  aplicarResultadoActivo(triggerFeedback);
}
buscador.addEventListener("input", () => recalcularResultados(false));

btnPrev.addEventListener("click", () => {
  if (resultadosActuales.length <= 1) return;
  indiceActual = (indiceActual - 1 + resultadosActuales.length) % resultadosActuales.length;
  aplicarResultadoActivo(true);
});
btnNext.addEventListener("click", () => {
  if (resultadosActuales.length <= 1) return;
  indiceActual = (indiceActual + 1) % resultadosActuales.length;
  aplicarResultadoActivo(true);
});

/* =========================
   Dark mode
========================= */
(function initDark(){
  const saved = localStorage.getItem("darkMode");
  if (saved === "1") document.body.classList.add("dark");
  btnDark.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è Modo claro" : "üåô Modo oscuro";
})();
btnDark.addEventListener("click", () => {
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode", document.body.classList.contains("dark") ? "1" : "0");
  btnDark.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è Modo claro" : "üåô Modo oscuro";
  setTimeout(()=>renderIsometric(), 30);
  if (resultadosActuales.length) setTimeout(()=>aplicarResultadoActivo(false), 50);
});

/* =========================
   ISO MAP (plano general)
========================= */
function drawZones(){
  zoneNodes.clear();

  const zones = [
    { id:"Z1", cls:"z1", label:"ZONA 1", x:0,   y:0,   w:260, d:220, color:"#14b8a6" },
    { id:"Z2", cls:"z2", label:"ZONA 2", x:280, y:0,   w:320, d:220, color:"#2dd4bf" },
    { id:"Z3", cls:"z3", label:"ZONA 3", x:0,   y:240, w:260, d:300, color:"#5eead4" },
    { id:"A1", cls:"a1", label:"ALMAC√âN (A1)", x:280, y:240, w:320, d:300, color:"#93c5fd" },
  ];

  const gZones = svgEl("g", { id:"zones" });

  const floor = isoFace(
    [toScreen(0,0,0), toScreen(640,0,0), toScreen(640,560,0), toScreen(0,560,0)],
    { fill: document.body.classList.contains("dark") ? "#0b1220" : "#f8fafc", stroke: document.body.classList.contains("dark") ? "#1f2937" : "#cbd5e1", "stroke-width":"1" }
  );
  gZones.appendChild(floor);

  for (const z of zones){
    const poly = isoFace(
      [toScreen(z.x,z.y,0), toScreen(z.x+z.w,z.y,0), toScreen(z.x+z.w,z.y+z.d,0), toScreen(z.x,z.y+z.d,0)],
      { id:z.id, class:`iso-zone ${z.cls}`, "stroke-width":"2" }
    );
    zoneNodes.set(z.id, poly);
    gZones.appendChild(poly);

    const pos = toScreen(z.x + z.w*0.5, z.y + z.d*0.5, 0);
    const t = svgEl("text", {
      x: pos.x, y: pos.y,
      "text-anchor":"middle",
      "font-size":"46",
      "font-weight":"900",
      fill: z.color,
      "fill-opacity":"0.15",
    });
    t.textContent = z.label;
    gZones.appendChild(t);
  }

  isoMap.appendChild(gZones);
}

function drawRack(rack, zoneColor){
  const { x, y, w, d, h, levels, id } = rack;
  const g = svgEl("g", { class:"rack", "data-rack-id": id });

  const postsBack = [{x:x, y:y},{x:x+w, y:y}];
  for (const p of postsBack){
    g.appendChild(isoLine(toScreen(p.x,p.y,0), toScreen(p.x,p.y,h), { class:"post" }));
  }

  const spacing = h / levels;
  const thickness = 2;

  for (let i=0;i<levels;i++){
    const z = i*spacing + 10;
    const top = [toScreen(x,y,z), toScreen(x+w,y,z), toScreen(x+w,y+d,z), toScreen(x,y+d,z)];
    const front = [toScreen(x,y+d,z), toScreen(x+w,y+d,z), toScreen(x+w,y+d,z-thickness), toScreen(x,y+d,z-thickness)];
    const right = [toScreen(x+w,y,z), toScreen(x+w,y+d,z), toScreen(x+w,y+d,z-thickness), toScreen(x+w,y,z-thickness)];

    g.appendChild(isoFace(top,   { class:"shelfTop" }));
    g.appendChild(isoFace(front, { class:"shelfFront" }));
    g.appendChild(isoFace(right, { class:"shelfRight" }));
  }

  const postsFront = [{x:x+w, y:y+d},{x:x, y:y+d}];
  for (const p of postsFront){
    g.appendChild(isoLine(toScreen(p.x,p.y,0), toScreen(p.x,p.y,h), { class:"post" }));
  }

  const lp = toScreen(x + w/2, y + d/2, h + 18);
  const rect = svgEl("rect", {
    x: lp.x - 18, y: lp.y - 12, width: 36, height: 20, rx: 5,
    fill: "#ffffff", stroke: zoneColor, "stroke-width":"2"
  });
  const txt = svgEl("text", {
    x: lp.x, y: lp.y + 5,
    "text-anchor":"middle", "font-size":"11", "font-weight":"900", "font-family":"monospace",
    fill: "#1e293b"
  });
  txt.textContent = id.split("-")[1]; // E#
  g.appendChild(rect);
  g.appendChild(txt);

  return g;
}

function placeZoneRacks(zoneId, rackIds){
  const layout = ZONE_LAYOUT[zoneId] || { rows: 2, cols: 4, order: [] };

  const origin = {
    Z1:{ ox:20,  oy:20,  w:240, d:200 },
    Z2:{ ox:300, oy:20,  w:300, d:200 },
    Z3:{ ox:20,  oy:260, w:240, d:280 },
    A1:{ ox:300, oy:260, w:300, d:280 },
  }[zoneId];

  const rackW = 55;
  const rackD = 120;
  const rackH = 120;
  const levels = (zoneId === "A1") ? 8 : 6;

  const gapX = (origin.w - (layout.cols * rackW)) / Math.max(1, (layout.cols - 1));
  const gapY = (origin.d - (layout.rows * rackD)) / Math.max(1, (layout.rows - 1));

  const orderSet = new Set(layout.order);
  const missing = rackIds.filter(id => !orderSet.has(id));
  const finalOrder = [...layout.order.filter(id => rackIds.includes(id)), ...missing];

  const placed = [];
  for (let i=0;i<finalOrder.length;i++){
    const id = finalOrder[i];
    const col = i % layout.cols;
    const row = Math.floor(i / layout.cols);

    const x = origin.ox + col * (rackW + gapX);
    const y = origin.oy + row * (rackD + gapY);

    placed.push({ id, zone:zoneId, x, y, w:rackW, d:rackD, h:rackH, levels });
  }
  return placed;
}

function computeRacksLayoutFromSheet(){
  const zones = ["Z1","Z2","Z3","A1"];
  const sets = { Z1:new Set(), Z2:new Set(), Z3:new Set(), A1:new Set() };

  for (const p of productos){
    if (p.mainLoc?.estanteId && sets[p.mainLoc.zonaId]) sets[p.mainLoc.zonaId].add(p.mainLoc.estanteId);
    if (p.storeLoc?.estanteId && sets[p.storeLoc.zonaId]) sets[p.storeLoc.zonaId].add(p.storeLoc.estanteId);
  }

  racksIndex = { Z1:[], Z2:[], Z3:[], A1:[] };
  for (const z of zones){
    const ids = [...sets[z]];
    racksIndex[z] = placeZoneRacks(z, ids);
  }
}

function renderIsometric(){
  isoMap.innerHTML = "";
  rackNodes.clear();
  zoneNodes.clear();

  drawZones();
  computeRacksLayoutFromSheet();

  const all = [...racksIndex.Z1, ...racksIndex.Z2, ...racksIndex.Z3, ...racksIndex.A1];
  all.sort((a,b)=> (a.x+a.y+a.w+a.d) - (b.x+b.y+b.w+b.d));

  const zoneColor = { Z1:"#14b8a6", Z2:"#2dd4bf", Z3:"#5eead4", A1:"#93c5fd" };
  const gRacks = svgEl("g", { id:"racks" });

  for (const r of all){
    const node = drawRack(r, zoneColor[r.zone]);
    node.id = r.id;
    rackNodes.set(r.id, node);

    node.addEventListener("mouseenter", () => {
      clearHoverHL();
      node.classList.add("hoverHL");
      mapBadge.textContent = r.zone;

      if (document.activeElement === buscador) return;
      if (lastHoverQuery === null) lastHoverQuery = buscador.value;
      buscador.value = r.id.toLowerCase();
      recalcularResultados(false);
    });

    node.addEventListener("mouseleave", () => {
      node.classList.remove("hoverHL");
      mapBadge.textContent = "‚Äî";
      if (document.activeElement === buscador) return;

      if (lastHoverQuery !== null){
        buscador.value = lastHoverQuery;
        lastHoverQuery = null;
        recalcularResultados(false);
      }
    });

    node.addEventListener("click", () => {
      lastHoverQuery = null;
      buscador.value = r.id.toLowerCase();
      recalcularResultados(true);
    });

    gRacks.appendChild(node);
  }

  isoMap.appendChild(gRacks);

  if (resultadosActuales.length){
    aplicarResultadoActivo(false);
  }
}

function clearAllHL(){ clearMainHL(); clearStoreHL(); clearHoverHL(); }
function clearMainHL(){
  for (const z of zoneNodes.values()) z.classList.remove("mainHL");
  for (const r of rackNodes.values()) r.classList.remove("mainHL");
}
function clearStoreHL(){
  for (const z of zoneNodes.values()) z.classList.remove("storeHL");
  for (const r of rackNodes.values()) r.classList.remove("storeHL");
}
function clearHoverHL(){ for (const r of rackNodes.values()) r.classList.remove("hoverHL"); }

function applyHoverHL(mainRackId, storeRackId){
  clearHoverHL();
  if (mainRackId && rackNodes.get(mainRackId)) rackNodes.get(mainRackId).classList.add("hoverHL");
  if (storeRackId && rackNodes.get(storeRackId)) rackNodes.get(storeRackId).classList.add("hoverHL");
}

function applyMainStoreHL(mainLoc, storeLoc){
  clearMainHL(); clearStoreHL();

  if (mainLoc?.zonaId && zoneNodes.get(mainLoc.zonaId)) zoneNodes.get(mainLoc.zonaId).classList.add("mainHL");
  if (mainLoc?.estanteId && rackNodes.get(mainLoc.estanteId)) rackNodes.get(mainLoc.estanteId).classList.add("mainHL");

  if (storeLoc?.zonaId && zoneNodes.get(storeLoc.zonaId)) zoneNodes.get(storeLoc.zonaId).classList.add("storeHL");
  if (storeLoc?.estanteId && rackNodes.get(storeLoc.estanteId)) rackNodes.get(storeLoc.estanteId).classList.add("storeHL");

  const hasSelection = !!(mainLoc?.estanteId || storeLoc?.estanteId);
  if (hasSelection){
    for (const node of rackNodes.values()){
      const keep = node.classList.contains("mainHL") || node.classList.contains("storeHL");
      node.classList.toggle("dim", !keep);
    }
  } else {
    for (const node of rackNodes.values()) node.classList.remove("dim");
  }
}

/* =========================
   Active result + highlight
========================= */
function aplicarResultadoActivo(triggerFeedback = false){
  const total = resultadosActuales.length;

  metaResults.textContent = `${total} resultados`;
  resultCountPill.textContent = String(total);

  badgeDetallado.textContent = String(resultadosDetallado.length || 0);
  badgeReducido.textContent = String(resultadosReducido.length || 0);

  if (!total){
    resultCard.style.display = "none";
    clearAllHL();
    info.textContent = "Escribe para buscar o pasa el mouse por los racks.";
    mapBadge.textContent = "‚Äî";
    mostrarVistaEstante("", 0, 0);
    return;
  }

  if (indiceActual < 0) indiceActual = 0;
  if (indiceActual >= total) indiceActual = total - 1;

  const filaActiva = resultadosActuales[indiceActual];
  const activo = (modo === "reducido" && filaActiva._representante)
    ? filaActiva._representante
    : filaActiva;

  renderTabla(resultadosActuales, indiceActual);

  applyMainStoreHL(activo.mainLoc, activo.storeLoc);

  mapBadge.textContent = activo.mainLoc?.zonaId || "‚Äî";
  pillZona.textContent = activo.mainLoc?.zonaId || "‚Äî";

  const mainPretty = activo.mainLoc?.pretty || "‚Äî";
  const storePretty = (activo.storeLoc?.pretty && activo.storeLoc?.zonaId) ? activo.storeLoc.pretty : "";

  info.textContent = storePretty
    ? `üìç Ubicaci√≥n: ${mainPretty}  ‚Ä¢  üì¶ Almac√©n: ${storePretty}`
    : `üìç Ubicaci√≥n: ${mainPretty}`;

  resultCard.style.display = "block";
  bigLoc.textContent = storePretty ? `${mainPretty}  |  ALMAC√âN: ${storePretty}` : mainPretty;

  subLoc.textContent = (modo === "reducido" && filaActiva._count)
    ? `${filaActiva.nombre || "‚Äî"} ‚Ä¢ ${filaActiva._count} variantes`
    : `${activo.nombre || "‚Äî"} ‚Ä¢ ${activo.variante || "‚Äî"} ‚Ä¢ ${activo.barras || "‚Äî"}`;

  kvUbicacion.textContent = mainPretty || "‚Äî";
  kvEstante.textContent = activo.mainLoc?.estanteId || "‚Äî";
  kvNivel.textContent = activo.mainLoc?.nivelId || "‚Äî";
  kvSlot.textContent = activo.mainLoc?.slotNum ? ("S" + activo.mainLoc.slotNum) : "‚Äî";
  kvAlmacen.textContent = storePretty || "‚Äî";

  // ‚úÖ Vista Estante isom√©trica (usa slot real si viene)
  mostrarVistaEstante(activo.mainLoc?.estanteId || "", activo.mainLoc?.levelNum || 1, activo.mainLoc?.slotNum || DEFAULT_SLOT);

  setPickerState();
  if (triggerFeedback) feedbackOK();
}

/* =========================
   GOOGLE SHEET LOADER (corregido para GitHub Pages)
   - parse robusto (sin substring m√°gico)
   - cachebust para evitar respuestas cacheadas raras
========================= */
setStatus("warn", `Cargando hoja ‚Äú${sheetName}‚Äù...`);

function parseGVizTextToJson(text){
  const start = text.indexOf("{");
  const end = text.lastIndexOf("}");
  if (start === -1 || end === -1) throw new Error("Respuesta gviz sin JSON.");
  return JSON.parse(text.substring(start, end + 1));
}

(function loadSheet(){
  const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json&cachebust=${Date.now()}`;
  fetch(url)
    .then(res => res.text())
    .then(text => {
      if (text.includes("<html") || text.includes("<!DOCTYPE")) {
        throw new Error("Google devolvi√≥ HTML (permisos/login). Publica la hoja o habilita acceso.");
      }
      const json = parseGVizTextToJson(text);
      const rows = json?.table?.rows || [];

      productos = [];
      for (const r of rows){
        if (!r.c) continue;

        // ‚ö†Ô∏è columnas seg√∫n tu sheet actual
        const barras = r.c[10]?.v || "";
        const nombre = r.c[12]?.v || "";
        const variante = r.c[13]?.v || "";

        const ubicRaw = r.c[20]?.v || "";    // z1-e1-n6-s2
        const almacenRaw = r.c[21]?.v || ""; // a1-e2-n6-s3

        const mainLoc = parseLoc(ubicRaw);
        const storeLoc = parseLoc(almacenRaw);

        const p = {
          barras,
          nombre,
          variante,
          ubic: mainLoc.pretty || "",
          almacen: storeLoc.pretty || "",
          mainLoc,
          storeLoc
        };

        if (!barras && !nombre) continue;

        p.nvNorm = norm((p.nombre || "") + " " + (p.variante || ""));
        p.fulltextNorm = norm((p.barras||"") + " " + (p.nombre||"") + " " + (p.variante||"") + " " + (p.ubic||"") + " " + (p.almacen||""));
        p.nombreNorm = norm(p.nombre);
        p.nombreNormKey = p.nombreNorm;

        productos.push(p);
      }

      metaCount.textContent = `${productos.length} productos`;
      renderTabla(productos);

      isLoaded = true;
      setStatus("ok", `Listo ‚Ä¢ ${productos.length} productos cargados`);
      renderIsometric();
    })
    .catch(err => {
      console.error("SHEET ERROR:", err);
      setStatus("bad", "Error cargando la hoja (revisa permisos/columnas).");
      info.textContent = `‚ùå ${err.message}`;
    });
})();

/* =========================
   Scanner
========================= */
const btnScan = document.getElementById("btnScan");
const btnCerrar = document.getElementById("btnCerrar");
const readerDiv = document.getElementById("reader");
let html5QrCode = null;

btnScan.addEventListener("click", () => {
  readerDiv.style.display = "block";
  btnCerrar.style.display = "inline-flex";
  if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(cameras => {
    const cameraId = cameras.find(c => c.label.toLowerCase().includes("back"))?.id || cameras[0]?.id;
    if (!cameraId) return;

    html5QrCode.start(
      cameraId,
      { fps: 20, qrbox: { width: 260, height: 200 }, experimentalFeatures: { useBarCodeDetectorIfSupported: true } },
      codigo => {
        html5QrCode.stop().then(() => {
          readerDiv.style.display = "none";
          btnCerrar.style.display = "none";
        });
        feedbackOK();
        buscador.value = codigo;
        recalcularResultados(false);
      }
    );
  });
});

btnCerrar.addEventListener("click", () => {
  if (html5QrCode){
    html5QrCode.stop().then(() => {
      readerDiv.style.display = "none";
      btnCerrar.style.display = "none";
    });
  }
});
</script>

</body>
</html>
