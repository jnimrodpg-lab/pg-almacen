<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TIENDAS PG ‚Ä¢ Localizador</title>

<style>
  :root{
    --bg:#f6f6f6; --card:#ffffff; --text:#111827; --muted:#6b7280;
    --border:#e5e7eb; --primary:#2563eb; --danger:#dc2626;
    --warn:#f59e0b; --ok:#16a34a; --shadow:0 10px 25px rgba(0,0,0,.08);
    --radius:14px;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--text); padding:20px; }

  /* ===== HEADER ===== */
  .topbar{
    max-width:1200px; margin:0 auto 16px auto;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  .brand{ display:flex; align-items:center; gap:12px; }
  .logoMark{
    width:44px;height:44px;border-radius:14px;
    background: linear-gradient(135deg, #111827, #374151);
    box-shadow: var(--shadow); position:relative; overflow:hidden;
  }
  .logoMark::before,.logoMark::after{
    content:""; position:absolute; top:10px; width:10px; height:24px;
    border-radius:6px; background: rgba(255,255,255,.85); opacity:.9;
  }
  .logoMark::before{ left:12px; } .logoMark::after{ right:12px; }
  .logoBase{
    position:absolute; left:10px; right:10px; bottom:8px;
    height:4px; border-radius:999px; background: rgba(255,255,255,.75);
  }
  .brandText{ display:flex; flex-direction:column; line-height:1.05; }
  .brandText .title{ font-size:18px; font-weight:900; letter-spacing:.5px; margin:0; }
  .brandText .subtitle{ font-size:12px; color:var(--muted); margin-top:4px; }
  .brandText .tag{
    display:inline-flex; align-items:center; gap:6px;
    margin-top:6px; font-size:11px;
    border:1px solid var(--border); background:#fff;
    padding:6px 10px; border-radius:999px; width:max-content;
  }

  .status{
    display:flex; align-items:center; gap:8px;
    padding:10px 12px; border:1px solid var(--border);
    border-radius:999px; background:var(--card);
    box-shadow:0 6px 18px rgba(0,0,0,.05);
    white-space:nowrap; font-size:13px; color:var(--muted);
  }
  .dot{ width:10px;height:10px;border-radius:999px;background:var(--warn); }
  .dot.ok{ background:var(--ok); } .dot.bad{ background:var(--danger); }

  /* ===== LAYOUT ===== */
  .layout{
    max-width:1200px; margin:0 auto; display:grid;
    grid-template-columns: 1.1fr .9fr; gap:16px; align-items:start;
  }
  @media (max-width: 980px){
    .layout{ grid-template-columns:1fr; }
    .sticky{ position:static !important; }
  }

  .card{
    background:var(--card); border:1px solid var(--border);
    border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
  }
  .card-header{
    padding:14px 14px 10px 14px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .card-header h2{ font-size:14px; margin:0; }
  .meta{ font-size:12px; color:var(--muted); }

  /* ===== MAPA ===== */
  .sticky{ position: sticky; top: 20px; }
  #mapa{ width:100%; border:1px solid var(--border); border-radius:12px; background:#fff; }

  .zona{ fill:#e8eef7; stroke:#333; stroke-width:2; transition:.18s; }
  .highlight{ fill:#fbbf24 !important; stroke:#f97316 !important; stroke-width:4; } /* b√∫squeda */
  .hover{ fill:#93c5fd !important; stroke:#2563eb !important; stroke-width:4; }     /* mouse */

  /* ===== ESTANTES CON IMAGEN (SVG) ===== */
  .estante-img { cursor:pointer; }
  .estante-img image { opacity:.98; transition:.18s; }
  .highlight-slot image{ filter: drop-shadow(0 0 10px rgba(249,115,22,.55)); }
  .hover-slot image{ filter: drop-shadow(0 0 10px rgba(37,99,235,.55)); }

  .nivel-mark{
    fill: rgba(251,191,36,.35);
    stroke: rgba(249,115,22,.95);
    stroke-width: 2;
    rx: 10; ry: 10;
    opacity: 0;
    pointer-events: none;
    transition: .18s;
  }
  .highlight-level .nivel-mark{ opacity: 1; }
  .hover-level .nivel-mark{ opacity: 1; fill: rgba(147,197,253,.30); stroke: rgba(37,99,235,.95); }

  .map-info{
    padding:12px 14px; border-top:1px solid var(--border);
    display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
  }
  .map-info .msg{ font-size:13px; color:var(--muted); line-height:1.4; }
  .pill{
    padding:6px 10px; border-radius:999px;
    font-size:12px; border:1px solid var(--border);
    background:#fff; color:var(--muted); white-space:nowrap;
  }

  /* ===== FORM + TABLA ===== */
  .controls{ padding:14px; display:grid; gap:10px; }
  .search input{
    width:100%; padding:12px; font-size:15px;
    border:1px solid var(--border); border-radius:12px; outline:none;
  }
  .search input:focus{
    border-color: rgba(37, 99, 235, .6);
    box-shadow: 0 0 0 4px rgba(37,99,235,.12);
  }

  .btnrow{ display:flex; gap:10px; flex-wrap:wrap; }
  .btn{
    flex:1; min-width:140px; border:none; border-radius:12px;
    padding:12px; font-size:14px; cursor:pointer; color:#fff;
    display:flex; align-items:center; justify-content:center; gap:8px;
  }
  .btn.primary{ background:var(--primary); }
  .btn.danger{ background:var(--danger); }
  .btn.dark{ background:#111827; }

  /* ===== CHIPS ===== */
  .chiprow{ display:flex; gap:8px; flex-wrap:wrap; }
  .chip{
    border:1px solid var(--border);
    background:#fff; color:#111827;
    border-radius:999px;
    padding:8px 10px;
    font-size:12px;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:8px;
    user-select:none;
  }
  .chip .badge{
    font-size:11px;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#f9fafb;
    color:var(--muted);
  }
  .chip.active{
    border-color: rgba(37,99,235,.35);
    box-shadow: 0 0 0 4px rgba(37,99,235,.10);
  }
  .chip.active .badge{
    border-color: rgba(37,99,235,.35);
    background: rgba(37,99,235,.08);
    color: #1f3b8f;
  }

  .hint{ font-size:12px; color:var(--muted); line-height:1.4; }

  .result-card{
    margin-top:6px; padding:12px; border:1px dashed var(--border);
    border-radius:12px; background:#fafafa; display:none;
  }
  .result-title{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .bigloc{ margin-top:8px; font-size:22px; font-weight:800; letter-spacing:.5px; }
  .sub{ margin-top:6px; font-size:12px; color:var(--muted); }

  .kv{ margin-top:10px; display:grid; gap:8px; }
  .kv-row{
    display:flex; justify-content:space-between; gap:10px;
    padding:10px 12px; border:1px solid var(--border);
    border-radius:12px; background:#fff; font-size:12px;
  }
  .kv-row b{ color:#111827; }
  .kv-row span{ color:var(--muted); text-align:right; }

  .picker{ margin-top:10px; display:flex; gap:10px; align-items:center; }
  .picker button{
    border:1px solid var(--border); background:#fff; color:#111827;
    border-radius:12px; padding:10px 12px; cursor:pointer;
    flex:1; min-width:120px; font-weight:700;
  }
  .picker button:disabled{ opacity:.45; cursor:not-allowed; }
  .picker .counter{
    padding:10px 12px; border:1px solid var(--border);
    background:#fff; border-radius:12px; color:var(--muted);
    font-size:12px; white-space:nowrap;
  }

  .table-wrap{ border-top:1px solid var(--border); }
  .table-scroll{ max-height: 520px; overflow:auto; }
  table{ width:100%; border-collapse:collapse; font-size:13px; }
  thead th{
    position:sticky; top:0; background:#111827; color:#fff;
    text-align:left; padding:10px; z-index:2;
  }
  tbody td{ padding:10px; border-bottom:1px solid var(--border); vertical-align:top; }
  tbody tr:nth-child(even){ background:#fafafa; }
  tbody tr.active{
    background:#fff7ed !important;
    outline:2px solid rgba(245, 158, 11, .35);
  }

  /* ===== Vista estante (IMG + franja overlay) ===== */
  .shelf-image-wrap{
    position:relative;
    width:100%;
    max-width:760px;
    margin:0 auto;
    aspect-ratio: 900 / 520;
  }
  .shelf-image{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:contain;
    border-radius:10px;
    user-select:none;
    pointer-events:none;
  }
  .shelf-level-overlay{
    position:absolute;
    left:14%;
    width:72%;
    border:2px solid rgba(249,115,22,.95);
    background:rgba(251,191,36,.35);
    border-radius:10px;
    box-shadow:0 0 0 3px rgba(249,115,22,.15) inset;
    transition:.18s;
  }
  .shelf-level-overlay .level-tag{
    position:absolute;
    left:-52px;
    top:50%;
    transform:translateY(-50%);
    font-size:11px;
    font-weight:700;
    color:#6b7280;
    background:#fff;
    border:1px solid var(--border);
    border-radius:999px;
    padding:2px 8px;
  }

  #reader{ display:none; padding:0 14px 14px 14px; }
</style>
</head>

<body>

<div class="topbar">
  <div class="brand">
    <div class="logoMark"><div class="logoBase"></div></div>
    <div class="brandText">
      <div class="title">TIENDAS PG</div>
      <div class="subtitle">Localizador de inventario</div>
      <div class="tag">üè¨ TIENDA</div>
    </div>
  </div>

  <div class="status">
    <span class="dot" id="statusDot"></span>
    <span id="statusText">Cargando hoja ‚ÄúMujer‚Äù...</span>
  </div>
</div>

<div class="layout">

  <!-- IZQUIERDA -->
  <div class="card">
    <div class="card-header">
      <div>
        <h2>B√∫squeda</h2>
        <div class="meta" id="metaCount">0 productos</div>
      </div>
      <div class="meta" id="metaResults">0 resultados</div>
    </div>

    <div class="controls">
      <div class="search">
        <input id="buscar" type="text" placeholder="Ej: bvd emperador blanco s  |  z4-e10-n8" autocomplete="off" />
      </div>

      <!-- CHIPS -->
      <div class="chiprow">
        <div class="chip active" id="chipReducido" role="button" tabindex="0">
          Reducido (por nombre) <span class="badge" id="badgeReducido">0</span>
        </div>
        <div class="chip" id="chipDetallado" role="button" tabindex="0">
          Detallado (todo) <span class="badge" id="badgeDetallado">0</span>
        </div>
      </div>

      <div class="btnrow">
        <button class="btn primary" id="btnScan" type="button">üì∑ Escanear</button>
        <button class="btn danger" id="btnCerrar" type="button" style="display:none;">‚ùå Cerrar</button>
        <button class="btn dark" id="btnClear" type="button">üßπ Limpiar</button>
      </div>

      <div class="hint">
        <b>Reducido:</b> 1 fila por nombre. <b>Detallado:</b> todas las coincidencias.
      </div>

      <div class="result-card" id="resultCard">
        <div class="result-title">
          <strong>Resultado activo</strong>
          <span class="pill" id="pillZona">‚Äî</span>
        </div>

        <div class="bigloc" id="bigLoc">‚Äî</div>
        <div class="sub" id="subLoc">‚Äî</div>

        <div class="kv">
          <div class="kv-row">
            <b>üìç Ubicaci√≥n</b>
            <span id="kvUbicacion">‚Äî</span>
          </div>
          <div class="kv-row">
            <b>üß± Estante</b>
            <span id="kvEstante">‚Äî</span>
          </div>
          <div class="kv-row">
            <b>üìö Nivel / Repisa</b>
            <span id="kvNivel">‚Äî</span>
          </div>
          <div class="kv-row">
            <b>üì¶ Reserva (Almac√©n)</b>
            <span id="kvReserva">‚Äî</span>
          </div>
        </div>

        <div class="picker">
          <button id="btnPrev" type="button">‚óÄ Anterior</button>
          <div class="counter" id="pickerCounter">0 / 0</div>
          <button id="btnNext" type="button">Siguiente ‚ñ∂</button>
        </div>
      </div>
    </div>

    <div id="reader"></div>

    <div class="table-wrap">
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th style="width:140px;">Barras</th>
              <th>Nombre</th>
              <th style="width:160px;">Variante</th>
              <th style="width:140px;">Ubicaci√≥n</th>
              <th style="width:110px;">Almac√©n</th>
            </tr>
          </thead>
          <tbody id="tabla"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- DERECHA: MAPA + VISTA ESTANTE -->
  <div class="card sticky">
    <div class="card-header">
      <div>
        <h2>Plano general</h2>
        <div class="meta">Zona + Estante + Nivel</div>
      </div>
      <div class="meta" id="mapBadge">‚Äî</div>
    </div>

    <div style="padding:14px;">
      <svg id="mapa" viewBox="0 0 700 800">
        <!-- ZONAS -->
        <rect id="Z1" class="zona" x="100" y="20" width="300" height="120"/>
        <text x="250" y="90" text-anchor="middle" font-size="16">ZONA 1</text>

        <rect id="Z2" class="zona" x="100" y="150" width="300" height="300"/>
        <text x="250" y="320" text-anchor="middle" font-size="16">ZONA 2</text>

        <!-- Zona 4 en el plano general se llama A -->
        <rect id="A" class="zona" x="420" y="150" width="220" height="300" stroke-dasharray="6"/>
        <text x="530" y="320" text-anchor="middle" font-size="16">ZONA 4</text>
        <text x="530" y="340" text-anchor="middle" font-size="12" fill="#6b7280">ALMAC√âN</text>

        <rect id="Z3" class="zona" x="100" y="460" width="300" height="300"/>
        <text x="250" y="650" text-anchor="middle" font-size="16">ZONA 3</text>

        <!-- ESTANTE EJEMPLO CON IMAGEN -->
        <g id="Z1-E2" class="estante-img" data-levels="6" transform="translate(140 35)">
          <image href="assets/estantes/estante-mod1.png" width="70" height="90" />
          <rect class="nivel-mark" x="0" y="0" width="70" height="15" />
        </g>
        <text x="175" y="30" font-size="10" text-anchor="middle" fill="#6b7280">E2</text>
      </svg>
    </div>

    <!-- VISTA ESTANTE -->
    <div style="padding:14px; border-top:1px solid var(--border);">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
        <div style="font-weight:800;">Vista estante seleccionado</div>
        <div class="pill" id="shelfLabel">‚Äî</div>
      </div>

      <div id="shelfPreview" style="
        border:1px solid var(--border);
        border-radius:12px;
        background:#fff;
        padding:12px;
        min-height:220px;
      ">
        <div style="color:var(--muted); font-size:13px;">
          Selecciona un producto para ver el estante y el nivel resaltado.
        </div>
      </div>
    </div>

    <div class="map-info">
      <div class="msg" id="info">Pasa el mouse por la tabla o busca un producto.</div>
      <div class="pill" id="resultCountPill">0</div>
    </div>
  </div>

</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ===== CONFIG ===== */
const sheetID   = "1IU4wMdVImmEbl93kgcCCQAGPiTc28uQdNNaq0bgTF2o";
const sheetName = "Mujer";

/* rutas im√°genes */
const IMG_EST_MAPA  = "assets/estantes/estante-mod1.png";
const IMG_EST_VISTA = "assets/estantes_vista/estante-mod1-vista1.png";

/* ===== UI refs ===== */
const tabla = document.getElementById("tabla");
const buscador = document.getElementById("buscar");
const info = document.getElementById("info");
const metaCount = document.getElementById("metaCount");
const metaResults = document.getElementById("metaResults");
const mapBadge = document.getElementById("mapBadge");
const resultCountPill = document.getElementById("resultCountPill");

const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");

const resultCard = document.getElementById("resultCard");
const pillZona = document.getElementById("pillZona");
const bigLoc = document.getElementById("bigLoc");
const subLoc = document.getElementById("subLoc");

const kvUbicacion = document.getElementById("kvUbicacion");
const kvEstante = document.getElementById("kvEstante");
const kvNivel = document.getElementById("kvNivel");
const kvReserva = document.getElementById("kvReserva");

const btnClear = document.getElementById("btnClear");
const btnPrev = document.getElementById("btnPrev");
const btnNext = document.getElementById("btnNext");
const pickerCounter = document.getElementById("pickerCounter");

const chipReducido = document.getElementById("chipReducido");
const chipDetallado = document.getElementById("chipDetallado");
const badgeReducido = document.getElementById("badgeReducido");
const badgeDetallado = document.getElementById("badgeDetallado");

/* Vista estante */
const shelfPreview = document.getElementById("shelfPreview");
const shelfLabel = document.getElementById("shelfLabel");

/* ===== STATE ===== */
let productos = [];
let resultadosDetallado = [];
let resultadosReducido = [];
let resultadosActuales = [];
let indiceActual = 0;
let modo = "reducido"; // ‚úÖ por defecto

/* ===== Feedback ===== */
let audioCtx = null;
function beep(freq = 880, ms = 90, vol = 0.06){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine"; o.frequency.value = freq; g.gain.value = vol;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); setTimeout(() => o.stop(), ms);
  }catch(e){}
}
function vibrar(pattern = [60, 40, 60]){
  try{ if (navigator.vibrate) navigator.vibrate(pattern); }catch(e){}
}
function feedbackOK(){
  beep(880, 80, 0.06);
  setTimeout(() => beep(1320, 70, 0.05), 90);
  vibrar([50, 35, 50]);
}

/* ===== Helpers ===== */
function setStatus(type, text){
  statusDot.className = "dot" + (type === "ok" ? " ok" : type === "bad" ? " bad" : "");
  statusText.textContent = text;
}
function escapeHtml(str){
  return String(str || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===== Parse ubicaci√≥n ===== */
function parseUbicacion(raw){
  const s = String(raw || "").trim().toUpperCase();
  const m = s.match(/^(Z[1234])(?:-(E\d+))?(?:-(N\d+))?$/);
  if (!m) return { zonaId: "", estanteId: "", nivelId: "", pretty: s, nivelNum: 0 };
  const zonaId = m[1] || "";
  const e = m[2] || "";
  const n = m[3] || "";
  const estanteId = (zonaId && e) ? `${zonaId}-${e}` : "";
  const nivelId   = (estanteId && n) ? `${estanteId}-${n}` : "";
  const nivelNum = n ? Number(n.replace("N","")) : 0;
  return { zonaId, estanteId, nivelId, pretty: s, nivelNum };
}

/* ===== zona mapa ===== */
function zonaMapaId(zonaId){
  if (zonaId === "Z4") return "A";
  return zonaId;
}

/* ===== Overlay nivel en SVG ===== */
function setShelfLevelMark(estanteId, nivelNum, mode){
  const g = document.getElementById(estanteId);
  if (!g) return;

  const img = g.querySelector("image");
  if (img) img.setAttribute("href", IMG_EST_MAPA);

  const mark = g.querySelector(".nivel-mark");
  if (!mark) return;

  const levels = Number(g.dataset.levels || 6);
  const w = Number(img?.getAttribute("width") || 60);
  const h = Number(img?.getAttribute("height") || 90);

  const n = Math.max(1, Math.min(levels, Number(nivelNum || 1)));
  const bandH = h / levels;
  const y = (n - 1) * bandH;

  mark.setAttribute("x", 0);
  mark.setAttribute("y", y);
  mark.setAttribute("width", w);
  mark.setAttribute("height", bandH);

  g.classList.toggle("hover-level", mode === "hover");
  g.classList.toggle("highlight-level", mode === "search");
}

/* ===== Highlight ===== */
function clearHover(){
  document.querySelectorAll(".zona").forEach(z => z.classList.remove("hover"));
  document.querySelectorAll(".estante-img").forEach(e => e.classList.remove("hover-slot","hover-level"));
}
function clearSearchHighlight(){
  document.querySelectorAll(".zona").forEach(z => z.classList.remove("highlight"));
  document.querySelectorAll(".estante-img").forEach(e => e.classList.remove("highlight-slot","highlight-level"));
}
function applyHover(zonaId, estanteId, nivelId){
  clearHover();
  if (zonaId) document.getElementById(zonaId)?.classList.add("hover");
  if (estanteId){
    const g = document.getElementById(estanteId);
    g?.classList.add("hover-slot");
    const n = (nivelId || "").match(/-N(\d+)$/i);
    const nivelNum = n ? Number(n[1]) : 1;
    if (g?.classList.contains("estante-img")) setShelfLevelMark(estanteId, nivelNum, "hover");
  }
}
function applySearchHighlight(zonaId, estanteId, nivelId){
  clearSearchHighlight();
  if (zonaId) document.getElementById(zonaId)?.classList.add("highlight");
  if (estanteId){
    const g = document.getElementById(estanteId);
    g?.classList.add("highlight-slot");
    const n = (nivelId || "").match(/-N(\d+)$/i);
    const nivelNum = n ? Number(n[1]) : 1;
    if (g?.classList.contains("estante-img")) setShelfLevelMark(estanteId, nivelNum, "search");
  }
}

/* ===== Vista estante (IMG + overlay) ===== */
function generarVistaEstanteConImagen(estanteId, nivelNum, totalNiveles){
  const n = Math.max(1, Math.min(totalNiveles, Number(nivelNum || 1)));
  const usable = 76, start = 10;
  const band = usable / totalNiveles;

  const bottomPct = start + ((n - 1) * band);
  const hPct = band - 1.2;

  return `
    <div class="shelf-image-wrap" aria-label="${estanteId}">
      <img class="shelf-image" src="${IMG_EST_VISTA}" alt="Vista de estante" />
      <div class="shelf-level-overlay" style="bottom:${bottomPct}%;height:${hPct}%;">
        <span class="level-tag">N${n}</span>
      </div>
    </div>
  `;
}
function mostrarVistaEstante(estanteId, nivelId){
  if (!estanteId){
    shelfLabel.textContent = "‚Äî";
    shelfPreview.innerHTML = `<div style="color:var(--muted); font-size:13px;">
      Selecciona un producto para ver el estante y el nivel resaltado.
    </div>`;
    return;
  }
  const n = (nivelId || "").match(/-N(\d+)$/i);
  const nivelNum = n ? Number(n[1]) : 1;
  const totalNiveles = estanteId.startsWith("Z4-") ? 8 : 6;

  shelfLabel.textContent = estanteId;
  shelfPreview.innerHTML = generarVistaEstanteConImagen(estanteId, nivelNum, totalNiveles);
}

/* ===== Normalizaci√≥n b√∫squeda ===== */
function norm(s){
  return String(s || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[ÃÄ-ÕØ]/g, "")
    .replace(/[^a-z0-9\s-]/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}
function tokens(s){
  const stop = new Set(["talla","color","de","para","con","sin","un","una","y","el","la","los","las"]);
  return norm(s).split(" ").filter(w => w && !stop.has(w));
}
function isSizeLetter(t){ return ["xs","s","m","l","xl","xxl","2xl"].includes(t); }
function isPureNumber(t){ return /^\d{1,4}$/.test(t); }
function matchAll(textoNorm, qTokens){
  for (const t of qTokens) if (!textoNorm.includes(t)) return false;
  return true;
}
function hasTallaNumero(nvNorm, num){
  return new RegExp(`\\btalla\\s*${num}\\b`).test(nvNorm);
}

/* ===== Agrupar por nombre (reducido) ===== */
function agruparPorNombre(listaDetallada){
  const map = new Map();
  for (const p of listaDetallada){
    const key = (p.nombreNormKey || p.nombreNorm || p.nombre || "").trim();
    if (!key) continue;

    if (!map.has(key)){
      map.set(key, { key, count: 1, representante: p, grupo: [p] });
    } else {
      const g = map.get(key);
      g.count++;
      g.grupo.push(p);
      if ((p._score||0) > (g.representante._score||0)) g.representante = p;
    }
  }

  const reducido = [];
  for (const g of map.values()){
    reducido.push({
      ...g.representante,
      variante: `${g.count} variantes`,
      _grupo: g.grupo,
      _count: g.count,
      _representante: g.representante
    });
  }

  // aqu√≠ no tenemos score inicial, as√≠ que ordenamos alfab√©tico para vista inicial
  reducido.sort((a,b) => String(a.nombre||"").localeCompare(String(b.nombre||""), "es"));
  return reducido;
}

/* ===== Render tabla ===== */
function renderTabla(lista, activeIndex = -1){
  let html = "";
  for (let i=0;i<lista.length;i++){
    const p = lista[i];
    const active = i === activeIndex ? " class='active'" : "";
    html += `
      <tr${active}
          data-i="${i}"
          data-zona="${p._zonaMapaId || ''}"
          data-estante="${p.estanteId || ''}"
          data-nivel="${p.nivelId || ''}">
        <td>${escapeHtml(p.barras || "")}</td>
        <td>${escapeHtml(p.nombre || "")}</td>
        <td>${escapeHtml(p.variante || "")}</td>
        <td>${escapeHtml(p.ubic || "")}</td>
        <td>${escapeHtml(p.almacen || "")}</td>
      </tr>`;
  }
  tabla.innerHTML = html;
  enlazarTabla();
}

function enlazarTabla(){
  const rows = tabla.querySelectorAll("tr");
  rows.forEach(tr => {
    tr.addEventListener("mouseenter", () => {
      const zonaId = tr.getAttribute("data-zona") || "";
      const estanteId = tr.getAttribute("data-estante") || "";
      const nivelId = tr.getAttribute("data-nivel") || "";

      applyHover(zonaId, estanteId, nivelId);
      mapBadge.textContent = (zonaId === "A") ? "ZONA 4" : (zonaId || "‚Äî");
    });

    tr.addEventListener("click", () => {
      const i = Number(tr.getAttribute("data-i"));
      if (!Number.isNaN(i)){
        indiceActual = i;
        aplicarResultadoActivo(true);
      }
    });
  });

  tabla.addEventListener("mouseleave", () => {
    clearHover();
    if (resultadosActuales.length){
      aplicarResultadoActivo(false);
    } else {
      mapBadge.textContent = "‚Äî";
      info.textContent = "Pasa el mouse por la tabla o busca un producto.";
    }
  }, { once:false });
}

/* ===== Picker ===== */
function setPickerState(){
  const total = resultadosActuales.length;
  pickerCounter.textContent = `${total ? (indiceActual + 1) : 0} / ${total}`;
  btnPrev.disabled = total <= 1;
  btnNext.disabled = total <= 1;
}

/* ===== Resultado activo ===== */
function aplicarResultadoActivo(triggerFeedback = false){
  const total = resultadosActuales.length;
  metaResults.textContent = `${total} resultados`;
  resultCountPill.textContent = String(total);

  badgeDetallado.textContent = String(resultadosDetallado.length || 0);
  badgeReducido.textContent = String(resultadosReducido.length || 0);

  if (!total){
    resultCard.style.display = "none";
    clearSearchHighlight();
    info.textContent = "Pasa el mouse por la tabla o busca un producto.";
    mapBadge.textContent = "‚Äî";
    mostrarVistaEstante("", "");
    return;
  }

  if (indiceActual < 0) indiceActual = 0;
  if (indiceActual >= total) indiceActual = total - 1;

  const filaActiva = resultadosActuales[indiceActual];
  const activo = (modo === "reducido" && filaActiva._representante)
    ? filaActiva._representante
    : filaActiva;

  renderTabla(resultadosActuales, indiceActual);

  applySearchHighlight(activo._zonaMapaId, activo.estanteId, activo.nivelId);

  mapBadge.textContent = (activo._zonaMapaId === "A") ? "ZONA 4" : (activo._zonaMapaId || "‚Äî");
  info.textContent = activo.almacen
    ? `üì¶ Reserva en ALMAC√âN (ZONA 4): ${activo.almacen}`
    : `üìç Ubicaci√≥n: ${activo.ubic || "‚Äî"}`;

  resultCard.style.display = "block";
  pillZona.textContent = (activo._zonaMapaId === "A") ? "ZONA 4" : (activo._zonaMapaId || "‚Äî");
  bigLoc.textContent = activo.almacen ? `RESERVA: ${activo.almacen}` : (activo.ubic || "‚Äî");

  if (modo === "reducido" && filaActiva._count){
    subLoc.textContent = `${filaActiva.nombre || "‚Äî"} ‚Ä¢ ${filaActiva._count} variantes`;
  } else {
    subLoc.textContent = `${activo.nombre || "‚Äî"} ‚Ä¢ ${activo.variante || "‚Äî"} ‚Ä¢ ${activo.barras || "‚Äî"}`;
  }

  kvUbicacion.textContent = activo.ubic || "‚Äî";
  kvEstante.textContent = activo.estanteId || "‚Äî";
  kvNivel.textContent = activo.nivelId || "‚Äî";
  kvReserva.textContent = activo.almacen || "‚Äî";

  mostrarVistaEstante(activo.estanteId, activo.nivelId);

  setPickerState();
  if (triggerFeedback) feedbackOK();
}

/* ===== Switch chips ===== */
function setModo(nuevo){
  modo = nuevo;
  chipReducido.classList.toggle("active", modo === "reducido");
  chipDetallado.classList.toggle("active", modo === "detallado");

  if (buscador.value.trim()){
    resultadosActuales = (modo === "reducido") ? resultadosReducido : resultadosDetallado;
    indiceActual = 0;
    aplicarResultadoActivo(false);
  } else {
    // ‚úÖ SIN b√∫squeda, igual mostramos por defecto REDUCIDO
    resultadosActuales = (modo === "reducido") ? resultadosReducido : resultadosDetallado;
    indiceActual = 0;
    renderTabla(resultadosActuales);
    resultCard.style.display = "none";
    clearSearchHighlight();
    mostrarVistaEstante("", "");
    metaResults.textContent = "0 resultados";
    resultCountPill.textContent = "0";
    badgeDetallado.textContent = String(resultadosDetallado.length || 0);
    badgeReducido.textContent = String(resultadosReducido.length || 0);
  }
}
chipReducido.addEventListener("click", () => setModo("reducido"));
chipDetallado.addEventListener("click", () => setModo("detallado"));

/* ===== Limpiar ===== */
function limpiarBusqueda(){
  buscador.value = "";
  indiceActual = 0;

  metaResults.textContent = "0 resultados";
  resultCountPill.textContent = "0";

  resultCard.style.display = "none";
  clearSearchHighlight();
  clearHover();

  info.textContent = "Pasa el mouse por la tabla o busca un producto.";
  mapBadge.textContent = "‚Äî";

  mostrarVistaEstante("", "");

  // ‚úÖ Volver a lista por defecto (REDUCIDO)
  modo = "reducido";
  chipReducido.classList.add("active");
  chipDetallado.classList.remove("active");

  resultadosActuales = resultadosReducido;
  renderTabla(resultadosActuales);

  buscador.focus();
}
document.getElementById("btnClear").addEventListener("click", limpiarBusqueda);

/* ===== Buscar ===== */
function recalcularResultados(triggerFeedback=false){
  const q = tokens(buscador.value);
  if (!q.length){
    limpiarBusqueda();
    return;
  }

  resultadosDetallado = productos
    .filter(p => matchAll(p.fulltextNorm, q))
    .map(p => {
      let score = 0;
      for (const t of q){
        const inNV = p.nvNorm.includes(t);
        if (isSizeLetter(t)){ score += inNV ? 20 : 5; continue; }
        if (isPureNumber(t)){
          if (hasTallaNumero(p.nvNorm, t)) score += 18;
          else score += inNV ? 6 : 2;
          continue;
        }
        score += inNV ? 10 : 2;
      }
      const code3 = q.find(t => /^\d{3}$/.test(t));
      if (code3 && p.nvNorm.includes(code3)) score += 12;
      return { ...p, _score: score };
    })
    .sort((a,b) => (b._score||0) - (a._score||0));

  resultadosReducido = agruparPorNombre(resultadosDetallado);

  resultadosActuales = (modo === "reducido") ? resultadosReducido : resultadosDetallado;
  indiceActual = 0;
  aplicarResultadoActivo(triggerFeedback);
}
buscador.addEventListener("input", () => recalcularResultados(false));

document.getElementById("btnPrev").addEventListener("click", () => {
  if (resultadosActuales.length <= 1) return;
  indiceActual = (indiceActual - 1 + resultadosActuales.length) % resultadosActuales.length;
  aplicarResultadoActivo(true);
});
document.getElementById("btnNext").addEventListener("click", () => {
  if (resultadosActuales.length <= 1) return;
  indiceActual = (indiceActual + 1) % resultadosActuales.length;
  aplicarResultadoActivo(true);
});

/* ===== LOAD SHEET ===== */
setStatus("warn", "Cargando hoja ‚ÄúMujer‚Äù...");

fetch(`https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`)
  .then(res => res.text())
  .then(text => {
    const json = JSON.parse(text.substring(47).slice(0, -2));
    const rows = json.table.rows;

    productos = [];
    for (const r of rows){
      if (!r.c) continue;

      const barras = r.c[10]?.v || "";
      const nombre = r.c[12]?.v || "";
      const variante = r.c[13]?.v || "";

      const ubicRaw = r.c[20]?.v || "";
      const almacen = String(r.c[21]?.v || "").toUpperCase().trim();

      const parsed = parseUbicacion(ubicRaw);

      const zonaId = almacen ? "Z4" : (parsed.zonaId || "");
      const estanteId = almacen ? "" : (parsed.estanteId || "");
      const nivelId = almacen ? "" : (parsed.nivelId || "");

      const p = {
        barras,
        nombre,
        variante,
        ubic: almacen ? "Z4" : parsed.pretty,
        almacen,

        zonaId,
        estanteId,
        nivelId,

        _zonaMapaId: zonaMapaId(zonaId)
      };

      if (!barras && !nombre) continue;

      p.nvNorm = norm((p.nombre || "") + " " + (p.variante || ""));
      p.fulltextNorm = norm((p.barras||"") + " " + (p.nombre||"") + " " + (p.variante||"") + " " + (p.ubic||"") + " " + (p.almacen||""));

      p.nombreNorm = norm(p.nombre);
      p.nombreNormKey = p.nombreNorm;

      productos.push(p);
    }

    metaCount.textContent = `${productos.length} productos`;

    // ‚úÖ POR DEFECTO: la tabla se muestra en "reducido" agrupado por nombre
    resultadosDetallado = productos;
    resultadosReducido = agruparPorNombre(productos);
    resultadosActuales = resultadosReducido;

    badgeDetallado.textContent = String(resultadosDetallado.length || 0);
    badgeReducido.textContent = String(resultadosReducido.length || 0);

    renderTabla(resultadosActuales);

    // UI
    modo = "reducido";
    chipReducido.classList.add("active");
    chipDetallado.classList.remove("active");

    setStatus("ok", `Listo ‚Ä¢ ${productos.length} productos cargados`);
  })
  .catch(() => setStatus("bad", "Error cargando la hoja. Revisa permisos del Sheet."));

/* ===== Scanner (QR + Barras) ===== */
const btnScan = document.getElementById("btnScan");
const btnCerrar = document.getElementById("btnCerrar");
const readerDiv = document.getElementById("reader");
let html5QrCode = null;

btnScan.addEventListener("click", () => {
  readerDiv.style.display = "block";
  btnCerrar.style.display = "inline-flex";
  if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(cameras => {
    const cameraId = cameras.find(c => c.label.toLowerCase().includes("back"))?.id || cameras[0]?.id;
    if (!cameraId) return;

    html5QrCode.start(
      cameraId,
      { fps: 20, qrbox: { width: 260, height: 200 }, experimentalFeatures: { useBarCodeDetectorIfSupported: true } },
      codigo => {
        html5QrCode.stop().then(() => {
          readerDiv.style.display = "none";
          btnCerrar.style.display = "none";
        });
        feedbackOK();
        buscador.value = codigo;
        recalcularResultados(false);
      }
    );
  });
});

btnCerrar.addEventListener("click", () => {
  if (html5QrCode){
    html5QrCode.stop().then(() => {
      readerDiv.style.display = "none";
      btnCerrar.style.display = "none";
    });
  }
});
</script>

</body>
</html>
