<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TIENDAS PG ‚Ä¢ Localizador</title>

<style>
  :root{
    --bg:#f6f6f6;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --border:#e5e7eb;
    --primary:#2563eb;
    --danger:#dc2626;
    --warn:#f59e0b;
    --ok:#16a34a;
    --shadow:0 10px 25px rgba(0,0,0,.08);
    --radius:14px;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    padding:20px;
  }

  /* ===== HEADER BRAND ===== */
  .topbar{
    max-width:1200px;
    margin:0 auto 16px auto;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }

  .brand{
    display:flex;
    align-items:center;
    gap:12px;
  }

  /* Logo simple (solo CSS) */
  .logoMark{
    width:44px;
    height:44px;
    border-radius:14px;
    background: linear-gradient(135deg, #111827, #374151);
    box-shadow: var(--shadow);
    position:relative;
    overflow:hidden;
  }
  /* 2 ‚Äúpasillos‚Äù tipo retail */
  .logoMark::before,
  .logoMark::after{
    content:"";
    position:absolute;
    top:10px;
    width:10px;
    height:24px;
    border-radius:6px;
    background: rgba(255,255,255,.85);
    opacity:.9;
  }
  .logoMark::before{ left:12px; }
  .logoMark::after{ right:12px; }
  /* l√≠nea inferior tipo ‚Äúbase‚Äù */
  .logoBase{
    position:absolute;
    left:10px;
    right:10px;
    bottom:8px;
    height:4px;
    border-radius:999px;
    background: rgba(255,255,255,.75);
  }

  .brandText{
    display:flex;
    flex-direction:column;
    line-height:1.05;
  }
  .brandText .title{
    font-size:18px;
    font-weight:900;
    letter-spacing:.5px;
    margin:0;
  }
  .brandText .subtitle{
    font-size:12px;
    color:var(--muted);
    margin-top:4px;
  }
  .brandText .tag{
    display:inline-flex;
    align-items:center;
    gap:6px;
    margin-top:6px;
    font-size:11px;
    color:#111827;
    border:1px solid var(--border);
    background:#fff;
    padding:6px 10px;
    border-radius:999px;
    width:max-content;
  }

  .status{
    display:flex; align-items:center; gap:8px;
    padding:10px 12px;
    border:1px solid var(--border);
    border-radius:999px;
    background:var(--card);
    box-shadow:0 6px 18px rgba(0,0,0,.05);
    white-space:nowrap;
    font-size:13px;
    color:var(--muted);
  }
  .dot{ width:10px;height:10px;border-radius:999px;background:var(--warn); }
  .dot.ok{ background:var(--ok); }
  .dot.bad{ background:var(--danger); }

  /* ===== LAYOUT ===== */
  .layout{
    max-width:1200px;
    margin:0 auto;
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap:16px;
    align-items:start;
  }
  @media (max-width: 980px){
    .layout{ grid-template-columns:1fr; }
    .right{ position:static !important; }
  }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }

  .card-header{
    padding:14px 14px 10px 14px;
    border-bottom:1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .card-header h2{ font-size:14px; margin:0; }
  .meta{ font-size:12px; color:var(--muted); }

  .controls{ padding:14px; display:grid; gap:10px; }
  .search input{
    width:100%;
    padding:12px 12px;
    font-size:15px;
    border:1px solid var(--border);
    border-radius:12px;
    outline:none;
  }
  .search input:focus{
    border-color: rgba(37, 99, 235, .6);
    box-shadow: 0 0 0 4px rgba(37,99,235,.12);
  }

  .btnrow{ display:flex; gap:10px; flex-wrap:wrap; }
  .btn{
    flex:1; min-width:140px;
    border:none; border-radius:12px;
    padding:12px 12px;
    font-size:14px; cursor:pointer;
    color:#fff;
    display:flex; align-items:center; justify-content:center; gap:8px;
  }
  .btn.primary{ background:var(--primary); }
  .btn.danger{ background:var(--danger); }
  .btn.dark{ background:#111827; }

  .hint{ font-size:12px; color:var(--muted); line-height:1.4; }

  .result-card{
    margin-top:6px;
    padding:12px;
    border:1px dashed var(--border);
    border-radius:12px;
    background:#fafafa;
    display:none;
  }
  .result-title{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .pill{
    padding:6px 10px; border-radius:999px;
    font-size:12px; border:1px solid var(--border);
    background:#fff; color:var(--muted);
    white-space:nowrap;
  }
  .bigloc{ margin-top:8px; font-size:22px; font-weight:800; letter-spacing:.5px; }
  .sub{ margin-top:6px; font-size:12px; color:var(--muted); }

  .kv{
    margin-top:10px;
    display:grid;
    gap:8px;
  }
  .kv-row{
    display:flex;
    justify-content:space-between;
    gap:10px;
    padding:10px 12px;
    border:1px solid var(--border);
    border-radius:12px;
    background:#fff;
    font-size:12px;
  }
  .kv-row b{ color:#111827; }
  .kv-row span{ color:var(--muted); text-align:right; }

  .picker{
    margin-top:10px;
    display:flex;
    gap:10px;
    align-items:center;
  }
  .picker button{
    border:1px solid var(--border);
    background:#fff;
    color:#111827;
    border-radius:12px;
    padding:10px 12px;
    cursor:pointer;
    flex:1;
    min-width:120px;
    font-weight:700;
  }
  .picker button:disabled{
    opacity:.45;
    cursor:not-allowed;
  }
  .picker .counter{
    padding:10px 12px;
    border:1px solid var(--border);
    background:#fff;
    border-radius:12px;
    color:var(--muted);
    font-size:12px;
    white-space:nowrap;
  }

  .table-wrap{ border-top:1px solid var(--border); }
  .table-scroll{ max-height: 520px; overflow:auto; }
  table{ width:100%; border-collapse:collapse; font-size:13px; }
  thead th{
    position:sticky; top:0;
    background:#111827; color:#fff;
    text-align:left; padding:10px; z-index:2;
  }
  tbody td{ padding:10px; border-bottom:1px solid var(--border); vertical-align:top; }
  tbody tr:nth-child(even){ background:#fafafa; }
  tbody tr.active{
    background:#fff7ed !important;
    outline:2px solid rgba(245, 158, 11, .35);
  }

  .right{ position: sticky; top: 20px; }
  #mapa{
    width:100%;
    border:1px solid var(--border);
    border-radius:12px;
    background:#fff;
  }

  .zona{ fill:#e8eef7; stroke:#333; stroke-width:2; transition:.25s; }
  .highlight{ fill:#fbbf24 !important; stroke:#f97316 !important; stroke-width:4; }

  .estante rect{ fill:#ffffff; stroke:#444; stroke-width:2; transition:.25s; }
  .highlight-estante rect{ fill:#fb7185 !important; stroke:#be123c !important; stroke-width:3; }

  .pasillo{ fill:#f3f4f6; stroke:#e5e7eb; stroke-width:1; }

  .map-info{
    padding:12px 14px;
    border-top:1px solid var(--border);
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10px;
  }
  .map-info .msg{ font-size:13px; color:var(--muted); line-height:1.4; }

  #reader{ display:none; padding:0 14px 14px 14px; }
</style>
</head>

<body>

<div class="topbar">
  <div class="brand">
    <div class="logoMark"><div class="logoBase"></div></div>
    <div class="brandText">
      <div class="title">TIENDAS PG</div>
      <div class="subtitle">Localizador de inventario</div>
      <div class="tag">üè¨ TIENDA</div>
    </div>
  </div>

  <div class="status">
    <span class="dot" id="statusDot"></span>
    <span id="statusText">Cargando hoja ‚ÄúMujer‚Äù...</span>
  </div>
</div>

<div class="layout">

  <!-- LEFT -->
  <div class="card">
    <div class="card-header">
      <div>
        <h2>B√∫squeda</h2>
        <div class="meta" id="metaCount">0 productos</div>
      </div>
      <div class="meta" id="metaResults">0 resultados</div>
    </div>

    <div class="controls">
      <div class="search">
        <input id="buscar" type="text" placeholder="Escanea o escribe..." autocomplete="off" />
      </div>

      <div class="btnrow">
        <button class="btn primary" id="btnScan" type="button">üì∑ Escanear</button>
        <button class="btn danger" id="btnCerrar" type="button" style="display:none;">‚ùå Cerrar</button>
        <button class="btn dark" id="btnClear" type="button">üßπ Limpiar</button>
      </div>

      <div class="hint">
        Modo Picker + feedback: sonido/vibraci√≥n al escanear y al cambiar resultado.
      </div>

      <div class="result-card" id="resultCard">
        <div class="result-title">
          <strong>Resultado activo</strong>
          <span class="pill" id="pillZona">‚Äî</span>
        </div>

        <div class="bigloc" id="bigLoc">‚Äî</div>
        <div class="sub" id="subLoc">‚Äî</div>

        <div class="kv">
          <div class="kv-row">
            <b>üîé B√∫squeda</b>
            <span id="kvBusqueda">‚Äî</span>
          </div>
          <div class="kv-row">
            <b>üìç Ubicaci√≥n (Tienda)</b>
            <span id="kvUbicacion">‚Äî</span>
          </div>
          <div class="kv-row">
            <b>üì¶ Reserva (Almac√©n)</b>
            <span id="kvReserva">‚Äî</span>
          </div>
        </div>

        <div class="picker">
          <button id="btnPrev" type="button">‚óÄ Anterior</button>
          <div class="counter" id="pickerCounter">0 / 0</div>
          <button id="btnNext" type="button">Siguiente ‚ñ∂</button>
        </div>
      </div>
    </div>

    <div id="reader"></div>

    <div class="table-wrap">
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th style="width:140px;">Barras</th>
              <th>Nombre</th>
              <th style="width:160px;">Variante</th>
              <th style="width:120px;">Ubicaci√≥n</th>
              <th style="width:110px;">Almac√©n</th>
            </tr>
          </thead>
          <tbody id="tabla"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="card right" id="mapCard" style="display:none;">
    <div class="card-header">
      <div>
        <h2>Mapa ‚Ä¢ Plano Retail</h2>
        <div class="meta">Resalta zona y estante</div>
      </div>
      <div class="meta" id="mapBadge">‚Äî</div>
    </div>

    <div style="padding:14px;">
      <svg id="mapa" viewBox="0 0 700 800">
        <rect id="Z1" class="zona" x="100" y="20" width="300" height="120"/>
        <text x="250" y="90" text-anchor="middle" font-size="16">ZONA 1</text>

        <rect id="Z2" class="zona" x="100" y="150" width="300" height="300"/>
        <text x="250" y="320" text-anchor="middle" font-size="16">ZONA 2</text>

        <rect class="pasillo" x="230" y="170" width="40" height="260"/>

        <g id="Z2-P1" class="estante"><rect x="120" y="170" width="90" height="260"/></g>
        <g id="Z2-D1" class="estante" transform="translate(350 230) rotate(90)"><rect x="-100" y="-40" width="200" height="80"/></g>
        <g id="Z2-D2" class="estante" transform="translate(350 320) rotate(90)"><rect x="-100" y="-40" width="200" height="80"/></g>

        <rect id="A" class="zona" x="420" y="150" width="220" height="300" stroke-dasharray="6"/>
        <text x="530" y="320" text-anchor="middle" font-size="16">ZONA 4</text>
        <text x="530" y="340" text-anchor="middle" font-size="12" fill="#6b7280">ALMAC√âN</text>

        <rect id="Z3" class="zona" x="100" y="460" width="300" height="300"/>
        <text x="250" y="650" text-anchor="middle" font-size="16">ZONA 3</text>
      </svg>
    </div>

    <div class="map-info">
      <div class="msg" id="info">Busca un producto para mostrar el mapa.</div>
      <div class="pill" id="resultCountPill">0</div>
    </div>
  </div>

</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const sheetID   = "1IU4wMdVImmEbl93kgcCCQAGPiTc28uQdNNaq0bgTF2o";
const sheetName = "Mujer";

const tabla = document.getElementById("tabla");
const buscador = document.getElementById("buscar");
const info = document.getElementById("info");
const mapCard = document.getElementById("mapCard");
const metaCount = document.getElementById("metaCount");
const metaResults = document.getElementById("metaResults");
const mapBadge = document.getElementById("mapBadge");
const resultCountPill = document.getElementById("resultCountPill");

const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");

const resultCard = document.getElementById("resultCard");
const pillZona = document.getElementById("pillZona");
const bigLoc = document.getElementById("bigLoc");
const subLoc = document.getElementById("subLoc");

const kvBusqueda = document.getElementById("kvBusqueda");
const kvUbicacion = document.getElementById("kvUbicacion");
const kvReserva = document.getElementById("kvReserva");

const btnClear = document.getElementById("btnClear");
const btnPrev = document.getElementById("btnPrev");
const btnNext = document.getElementById("btnNext");
const pickerCounter = document.getElementById("pickerCounter");

let productos = [];
let resultadosActuales = [];
let indiceActual = 0;

/* Feedback */
let audioCtx = null;
function beep(freq = 880, ms = 90, vol = 0.06){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.value = freq;
    g.gain.value = vol;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(() => { o.stop(); }, ms);
  }catch(e){}
}
function vibrar(pattern = [60, 40, 60]){
  try{ if (navigator.vibrate) navigator.vibrate(pattern); }catch(e){}
}
function feedbackOK(){
  beep(880, 80, 0.06);
  setTimeout(() => beep(1320, 70, 0.05), 90);
  vibrar([50, 35, 50]);
}

/* Helpers */
function setStatus(type, text){
  statusDot.className = "dot" + (type === "ok" ? " ok" : type === "bad" ? " bad" : "");
  statusText.textContent = text;
}
function escapeHtml(str){
  return String(str || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function renderTabla(lista, activeIndex = -1){
  let html = "";
  for (let i=0;i<lista.length;i++){
    const p = lista[i];
    const active = i === activeIndex ? " class='active'" : "";
    html += `
      <tr${active}>
        <td>${escapeHtml(p.barras)}</td>
        <td>${escapeHtml(p.nombre)}</td>
        <td>${escapeHtml(p.variante)}</td>
        <td>${escapeHtml(p.ubic)}</td>
        <td>${escapeHtml(p.almacen)}</td>
      </tr>`;
  }
  tabla.innerHTML = html;
}
function obtenerZona(ubicacion, almacen){
  if (almacen) return "A";
  if (ubicacion.startsWith("Z1")) return "Z1";
  if (ubicacion.startsWith("Z2")) return "Z2";
  if (ubicacion.startsWith("Z3")) return "Z3";
  return null;
}
function limpiarHighlights(){
  document.querySelectorAll(".zona").forEach(z => z.classList.remove("highlight"));
  document.querySelectorAll(".estante").forEach(e => e.classList.remove("highlight-estante"));
}
function setPickerState(){
  const total = resultadosActuales.length;
  pickerCounter.textContent = `${total ? (indiceActual + 1) : 0} / ${total}`;
  btnPrev.disabled = total <= 1;
  btnNext.disabled = total <= 1;
}

/* Aplicar resultado */
function aplicarResultadoActivo(triggerFeedback = false){
  const total = resultadosActuales.length;
  metaResults.textContent = `${total} resultados`;
  resultCountPill.textContent = String(total);

  if (!total){
    resultCard.style.display = "none";
    mapCard.style.display = "none";
    limpiarHighlights();
    return;
  }

  if (indiceActual < 0) indiceActual = 0;
  if (indiceActual >= total) indiceActual = total - 1;

  const activo = resultadosActuales[indiceActual];
  const zona = obtenerZona(activo.ubic, activo.almacen);

  renderTabla(resultadosActuales, indiceActual);

  limpiarHighlights();
  mapCard.style.display = "block";

  if (zona) document.getElementById(zona)?.classList.add("highlight");

  const estante = document.getElementById(activo.ubic);
  if (estante) estante.classList.add("highlight-estante");

  if (activo.almacen){
    info.textContent = `üì¶ Reserva en ALMAC√âN (ZONA 4): ${activo.almacen}`;
    mapBadge.textContent = "ZONA 4";
  } else {
    info.textContent = "üìç Ubicaci√≥n: " + (activo.ubic || "‚Äî");
    mapBadge.textContent = zona || "‚Äî";
  }

  resultCard.style.display = "block";
  pillZona.textContent = activo.almacen ? "ZONA 4" : (zona || "‚Äî");
  bigLoc.textContent = activo.almacen ? `RESERVA: ${activo.almacen}` : (activo.ubic || "‚Äî");
  subLoc.textContent = `${activo.nombre || "‚Äî"} ‚Ä¢ ${activo.variante || "‚Äî"} ‚Ä¢ ${activo.barras || "‚Äî"}`;

  kvBusqueda.textContent = buscador.value.trim() || "‚Äî";
  kvUbicacion.textContent = activo.ubic || "‚Äî";
  kvReserva.textContent = activo.almacen || "‚Äî";

  setPickerState();
  if (triggerFeedback) feedbackOK();
}

/* Load sheet */
setStatus("warn", "Cargando hoja ‚ÄúMujer‚Äù...");

fetch(`https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`)
  .then(res => res.text())
  .then(text => {
    const json = JSON.parse(text.substring(47).slice(0, -2));
    const rows = json.table.rows;

    productos = [];
    for (const r of rows){
      if (!r.c) continue;

      const p = {
        barras:   r.c[10]?.v || "",
        nombre:   r.c[12]?.v || "",
        variante: r.c[13]?.v || "",
        ubic:     (r.c[20]?.v || "").toUpperCase().trim(),
        almacen:  (r.c[21]?.v || "").toUpperCase().trim()
      };
      p.fulltext = (p.barras+" "+p.nombre+" "+p.variante+" "+p.ubic+" "+p.almacen).toLowerCase();
      if (!p.barras && !p.nombre) continue;
      productos.push(p);
    }

    metaCount.textContent = `${productos.length} productos`;
    resultadosActuales = [];
    indiceActual = 0;
    renderTabla(productos);
    setStatus("ok", `Listo ‚Ä¢ ${productos.length} productos cargados`);
  })
  .catch(() => setStatus("bad", "Error cargando la hoja. Revisa permisos del Sheet."));

/* Search */
function limpiarBusqueda(){
  buscador.value = "";
  resultadosActuales = [];
  indiceActual = 0;
  metaResults.textContent = "0 resultados";
  resultCard.style.display = "none";
  mapCard.style.display = "none";
  info.textContent = "Busca un producto para mostrar el mapa.";
  mapBadge.textContent = "‚Äî";
  resultCountPill.textContent = "0";
  limpiarHighlights();
  renderTabla(productos);
  buscador.focus();
}
btnClear.addEventListener("click", limpiarBusqueda);

function recalcularResultados(triggerFeedback=false){
  const filtro = buscador.value.toLowerCase().trim();

  if (!filtro){
    resultadosActuales = [];
    indiceActual = 0;
    metaResults.textContent = "0 resultados";
    resultCard.style.display = "none";
    mapCard.style.display = "none";
    limpiarHighlights();
    renderTabla(productos);
    return;
  }

  resultadosActuales = productos.filter(p => p.fulltext.includes(filtro));
  indiceActual = 0;
  aplicarResultadoActivo(triggerFeedback);
}
buscador.addEventListener("input", () => recalcularResultados(false));

btnPrev.addEventListener("click", () => {
  if (resultadosActuales.length <= 1) return;
  indiceActual = (indiceActual - 1 + resultadosActuales.length) % resultadosActuales.length;
  aplicarResultadoActivo(true);
});

btnNext.addEventListener("click", () => {
  if (resultadosActuales.length <= 1) return;
  indiceActual = (indiceActual + 1) % resultadosActuales.length;
  aplicarResultadoActivo(true);
});

/* Scanner */
const btnScan = document.getElementById("btnScan");
const btnCerrar = document.getElementById("btnCerrar");
const readerDiv = document.getElementById("reader");
let html5QrCode = null;

btnScan.addEventListener("click", () => {
  readerDiv.style.display = "block";
  btnCerrar.style.display = "inline-flex";

  if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(cameras => {
    const cameraId = cameras.find(c => c.label.toLowerCase().includes("back"))?.id || cameras[0]?.id;
    if (!cameraId) return;

    html5QrCode.start(
      cameraId,
      {
        fps: 20,
        qrbox: { width: 260, height: 200 },
        experimentalFeatures: { useBarCodeDetectorIfSupported: true }
      },
      codigo => {
        html5QrCode.stop().then(() => {
          readerDiv.style.display = "none";
          btnCerrar.style.display = "none";
        });

        feedbackOK();
        buscador.value = codigo;
        recalcularResultados(false);
      }
    );
  });
});

btnCerrar.addEventListener("click", () => {
  if (html5QrCode){
    html5QrCode.stop().then(() => {
      readerDiv.style.display = "none";
      btnCerrar.style.display = "none";
    });
  }
});
</script>

</body>
</html>

